# Unite-Hub Diagnostic Results
**Date**: 2025-12-03
**Status**: CRITICAL ISSUES FOUND

---

## Environment Variables

### Local (.env.local) - 73 variables configured ✅
Key variables present:
- `NEXT_PUBLIC_SUPABASE_URL`: HAS_VALUE
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: HAS_VALUE
- `SUPABASE_SERVICE_ROLE_KEY`: HAS_VALUE
- `ANTHROPIC_API_KEY`: HAS_VALUE (but INVALID - see below)
- `SENDGRID_API_KEY`: HAS_VALUE ✅
- `OPENROUTER_API_KEY`: HAS_VALUE ✅
- `GOOGLE_CLIENT_ID`: HAS_VALUE
- `GOOGLE_CLIENT_SECRET`: HAS_VALUE

### Vercel - 56 variables configured ✅
All core variables are deployed to Vercel.

---

## Supabase Connection

### Status: PARTIALLY WORKING ⚠️

**Working Tables:**
- `profiles`: EXISTS & ACCESSIBLE ✅
- `user_profiles`: EXISTS & ACCESSIBLE ✅
- `contacts`: EXISTS & ACCESSIBLE ✅
- `emails`: EXISTS & ACCESSIBLE ✅
- `campaigns`: EXISTS & ACCESSIBLE ✅

**BROKEN Tables (RLS Infinite Recursion):**
- `organizations`: ❌ infinite recursion detected in policy for relation "user_organizations"
- `user_organizations`: ❌ infinite recursion detected in policy for relation "user_organizations"
- `workspaces`: ❌ infinite recursion detected in policy for relation "user_organizations"

**Auth System:**
- Connection: ACCESSIBLE ✅
- Session: NONE (expected for unauthenticated request)

---

## Anthropic API

### Status: ❌ INVALID API KEY

```
Key prefix: sk-ant-api03-7V...
Error: 401 {"type":"error","error":{"type":"authentication_error","message":"invalid x-api-key"}}
```

**DIAGNOSIS**: The Anthropic API key is invalid, expired, or revoked. A new key must be generated from console.anthropic.com.

---

## OpenRouter API (Backup AI)

### Status: ✅ WORKING

```
Key prefix: sk-or-v1-d9f28d...
Response: OK
Model: anthropic/claude-3.5-sonnet
```

**NOTE**: OpenRouter can be used as backup while Anthropic key is fixed.

---

## SendGrid API

### Status: ✅ WORKING

```
Key prefix: SG.DzIFr0n...
Account: Phill McGurk
```

---

## Database Tables Analysis

### Two Profiles Tables Exist (CONFLICT):

1. **`user_profiles`** (Migration 003):
   - Columns: id, email, full_name, avatar_url, created_at, updated_at
   - Trigger: `handle_new_user()` inserts here on signup

2. **`profiles`** (Migration 255):
   - Columns: id, email, role, created_at, updated_at
   - Migration 308 adds user_role enum
   - NO TRIGGER to populate on signup!

**PROBLEM**: Code queries `profiles` for user role, but signup only populates `user_profiles`.

---

## Auth Flow Test

### Test: Email Signup with Password

**Action**: Filled registration form and clicked "Create Account"

**Result**: ❌ FAILED

**Error Message**: "Database error saving new user"

**Console**: `[ERROR] Failed to load resource: the server responded with a status of 500`

**Root Cause Analysis**:
The signup trigger chain is:
1. User signs up → `auth.users` INSERT
2. Trigger `on_auth_user_created` fires → `handle_new_user()` tries to INSERT into `user_profiles`
3. Then trigger `on_user_profile_created` fires → `handle_user_organization_assignment()`
4. This function queries `organization_invites` and may INSERT into `user_organizations`
5. **RLS INFINITE RECURSION** on `user_organizations` causes 500 error

---

## DIAGNOSIS

### Critical Issues (Must Fix):

1. **RLS Infinite Recursion** on `user_organizations` table
   - This is blocking ALL signups
   - Policies reference themselves causing infinite loop
   - **FIX**: Drop and recreate RLS policies without self-reference

2. **Invalid Anthropic API Key**
   - Key `sk-ant-api03-7V...` returns 401 authentication error
   - **FIX**: Generate new key at console.anthropic.com and update .env.local + Vercel

3. **Dual Profile Tables**
   - `user_profiles` and `profiles` both exist with different schemas
   - Trigger populates `user_profiles` but code queries `profiles` for role
   - **FIX**: Either:
     - Add trigger to also INSERT into `profiles`, OR
     - Rename `user_profiles` to `profiles` and migrate data, OR
     - Update all code to use `user_profiles` instead of `profiles`

### Working Systems:
- ✅ Supabase connection (basic)
- ✅ SendGrid email
- ✅ OpenRouter API (backup AI)
- ✅ App starts and renders
- ✅ Design system tokens applied

---

## Recommended Fix Order

1. **Fix RLS policies** (blocks all signups) - SQL migration required
2. **Fix Anthropic API key** (blocks AI features) - new key from Anthropic Console
3. **Resolve profiles table conflict** (blocks role-based access) - SQL migration + code update
4. **Test Google OAuth** (after signups work)

---

## SQL to Debug RLS Issue

Run this in Supabase SQL Editor to see the problematic policies:

```sql
SELECT
  schemaname,
  tablename,
  policyname,
  permissive,
  roles,
  cmd,
  qual
FROM pg_policies
WHERE tablename = 'user_organizations';
```

---

**Generated by**: Claude Code Diagnostic Tool
**Evidence**: All findings based on actual test results, not assumptions.
