# Phase 6.2: Complete Error Boundary Migration (Routes 14-20) - Plan

**Created**: 2025-12-02
**Status**: Draft - Awaiting User Approval

## Objective

Complete migration of remaining 7 API routes (14-20) from ad-hoc error handling to standardized `withErrorBoundary` error boundary pattern, achieving 100% completion of the Phase 6.2 initiative.

**Current Progress**: 13/20 routes complete (65%)
**Target**: 20/20 routes complete (100%)

## Requirements

### Functional Requirements
- All 7 remaining routes must use `withErrorBoundary` wrapper
- Proper error classification (AuthenticationError, ValidationError, NotFoundError, DatabaseError, etc.)
- All responses use `successResponse()` helper instead of `NextResponse.json()`
- Build verification after each route (must compile 590/590 pages)
- No breaking changes to API contracts
- All commits must pass ESLint and pre-commit hooks

### Quality Requirements
- Code review alignment with existing patterns (routes 1-13)
- ~15-20% code reduction per route
- Clear error messages and proper HTTP status codes
- Documentation of any deviations from standard pattern

### Success Criteria
- [ ] Route 14 (/api/ai-consultations/[id]) migrated
- [ ] Route 15 (/api/aido/clients/[id]) migrated
- [ ] Route 16 (/api/autonomy/proposals/[id]) migrated
- [ ] Route 17 (/api/autopilot/actions/[id]/approve) migrated
- [ ] Route 18 (/api/autopilot/actions/[id]/skip) migrated
- [ ] Route 19 (/api/approvals/[id]/approve) migrated
- [ ] Route 20 (/api/approvals/[id]/decline) migrated
- [ ] Final build verification: ✓ Compiled successfully (590/590 pages)
- [ ] All commits use proper Phase 6.2 commit message format
- [ ] No ESLint errors or warnings

## Implementation Steps

### Phase 1: Preparation & Planning (Completed)
- [x] Investigated middleware patterns (withAuth, handleErrors)
- [x] Documented error boundary architecture
- [x] Reviewed remaining 7 routes
- [x] Created migration protocol (PLAN_MODE_PROTOCOL.md)

### Phase 2: Route 14 Migration (10-15 min)
1. Read `/api/ai-consultations/[id]/route.ts`
2. Understand current error handling (3 handlers: GET, POST, PATCH)
3. Extract `validateAuth()` helper function
4. Replace try-catch blocks with `withErrorBoundary` wrapper
5. Convert `NextResponse.json()` to `successResponse()`
6. Map errors to proper exception classes
7. Add ESLint disable comments as needed
8. Commit: `refactor: Phase 6.2 - Migrate /api/ai-consultations/[id] to error boundaries`
9. Verify build succeeds: `npm run build 2>&1 | tail -5`

### Phase 3: Route 15 Migration (8-10 min)
1. Read `/api/aido/clients/[id]/route.ts`
2. Identify handler pattern (GET)
3. Apply standard error boundary transformation
4. Test and commit

### Phase 4: Route 16 Migration (10-12 min)
1. Read `/api/autonomy/proposals/[id]/route.ts`
2. Identify handler pattern (GET/PATCH)
3. Apply standard error boundary transformation
4. Test and commit

### Phase 5: Route 17 Migration (8-10 min)
1. Read `/api/autopilot/actions/[id]/approve/route.ts`
2. Identify handler pattern (POST)
3. Apply standard error boundary transformation
4. Test and commit

### Phase 6: Route 18 Migration (8-10 min)
1. Read `/api/autopilot/actions/[id]/skip/route.ts`
2. Identify handler pattern (POST)
3. Apply standard error boundary transformation
4. Test and commit

### Phase 7: Route 19 Migration (8-10 min)
1. Read `/api/approvals/[id]/approve/route.ts`
2. Identify handler pattern (POST)
3. Apply standard error boundary transformation
4. Test and commit

### Phase 8: Route 20 Migration (8-10 min)
1. Read `/api/approvals/[id]/decline/route.ts`
2. Identify handler pattern (POST)
3. Apply standard error boundary transformation
4. Test and commit

### Phase 9: Final Verification & Documentation (15-20 min)
1. Run full build: `npm run build 2>&1 | grep -E "Compiled|error"`
2. Verify: ✓ Compiled successfully in < 2 min
3. Generate completion metrics:
   - Total LOC saved: ~2,000+
   - Routes completed: 20/20 (100%)
   - Average time per route: ~12 minutes
4. Update PHASE_6_2_MIGRATION_PLAYBOOK.md with completion status
5. Final commit: `refactor: Phase 6.2 - Complete error boundary migration (20/20 routes)`

## Timeline & Effort Estimation

| Phase | Task | Duration | Cumulative |
|-------|------|----------|-----------|
| 1 | Preparation & Planning | ✓ Done | ✓ Done |
| 2 | Route 14 Migration | 12 min | 12 min |
| 3 | Route 15 Migration | 9 min | 21 min |
| 4 | Route 16 Migration | 11 min | 32 min |
| 5 | Route 17 Migration | 9 min | 41 min |
| 6 | Route 18 Migration | 9 min | 50 min |
| 7 | Route 19 Migration | 9 min | 59 min |
| 8 | Route 20 Migration | 9 min | 68 min |
| 9 | Final Verification | 18 min | 86 min |
| **Total** | **Phase 6.2 Completion** | **~90 minutes** | **1.5 hours** |

## Known Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|-----------|
| Middleware pattern complexity | Implementation delays | Medium | Document patterns before each migration |
| Build failures | Blocked on completion | Low | Verify after EACH route, not in batches |
| ESLint errors | Pre-commit hook failures | Low | Use proper disable comments (no-undef, etc.) |
| Route variation | Pattern inconsistency | Medium | Reference completed routes 1-13 as templates |
| Context window limits | May need continuation | Low | Batch into 3-4 routes per session |
| Breaking API changes | Test suite failures | Very Low | Only refactor error handling, not logic |

## Definition of Done

The Phase 6.2 initiative is complete when:

1. ✓ All 20 routes migrated to `withErrorBoundary`
2. ✓ Build succeeds: `590/590 pages compiled`
3. ✓ No ESLint errors in migrated files
4. ✓ All commits follow naming convention
5. ✓ Documentation updated with metrics
6. ✓ Metrics show ~2000 LOC reduction
7. ✓ No API contract changes

## Architecture Notes

### Error Classification
```typescript
- AuthenticationError (401) - Missing/invalid auth
- AuthorizationError (403) - Insufficient permissions
- ValidationError (400) - Invalid input/schema
- NotFoundError (404) - Resource doesn't exist
- ConflictError (409) - Resource already exists
- DatabaseError (500) - Database operation failed
- InternalServerError (500) - Unexpected error
```

### Response Pattern
```typescript
// Success
return successResponse(data, headers?, message?, statusCode?);

// Error (automatic via withErrorBoundary)
throw new AuthenticationError("message");
throw new ValidationError("code");
throw new NotFoundError("type", "id");
```

### Commit Message Format
```
refactor: Phase 6.2 - Migrate /api/route/path to error boundaries

- Replaced try-catch with withErrorBoundary
- Converted 3 handlers to standard pattern
- ~25% code reduction (X LOC → Y LOC)
```

## Assumptions

1. Routes 1-13 are complete and in git (✓ Verified)
2. Error boundary helpers are properly exported (✓ Verified)
3. Build environment is stable (✓ Last verified 13 minutes ago)
4. No API contract breaking changes required (✓ Confirmed)
5. ESLint configuration is consistent (✓ Pre-commit hooks working)

## Decision Points (Need User Input)

**Q1: Batch size?**
- Option A: Migrate all 7 routes in one session (90 min)
- Option B: Migrate 3-4 routes per session (2-3 sessions)
- *Recommendation*: Option A if time allows, else Option B

**Q2: Documentation scope?**
- Option A: Minimal (just commit messages)
- Option B: Detailed (update PHASE_6_2_MIGRATION_PLAYBOOK.md)
- Option C: Comprehensive (add to error boundaries reference guide)
- *Recommendation*: Option B balances detail and efficiency

**Q3: Error handling strictness?**
- Option A: Strict (throw on all errors, consistent)
- Option B: Pragmatic (keep some NextResponse.json for edge cases)
- *Recommendation*: Option A (routes 1-13 show this is feasible)

---

## Status

**Current**: Draft - Awaiting User Approval
**Last Updated**: 2025-12-02 14:45 UTC

### Approval Checklist
- [ ] User has reviewed this plan
- [ ] User has answered decision points (Q1-Q3)
- [ ] User has approved the timeline
- [ ] User is ready for execution to begin

### Next Step
Please review this plan and either:
1. **Approve as-is** (if you agree with all sections)
2. **Request changes** (edit this file and return)
3. **Ask clarifying questions** (if anything is unclear)

Once approved, I'll begin Phase 2 with Route 14 migration.

