name: Nightly Health Check

on:
  schedule:
      - cron: '0 2 * * *'
        workflow_dispatch:

        env:
          PRODUCTION_URL: https://unite-hub.vercel.app

          jobs:
            health-check:
                name: System Health Check
                    runs-on: ubuntu-latest
                        steps:
                              - uses: actions/checkout@v4

                                    - name: Check API Health
                                            id: health
                                                    run: |
                                                              RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 30 "${{ env.PRODUCTION_URL }}/api/health" 2>&1 || echo -e "\nFAILED")
                                                                        HTTP_CODE=$(echo "$RESPONSE" | tail -1)
                                                                                  BODY=$(echo "$RESPONSE" | head -n -1)
                                                                                            echo "HTTP Status: $HTTP_CODE"
                                                                                                      echo "Response: $BODY"
                                                                                                                if [ "$HTTP_CODE" = "200" ]; then
                                                                                                                            echo "status=healthy" >> $GITHUB_OUTPUT
                                                                                                                                      else
                                                                                                                                                  echo "status=unhealthy" >> $GITHUB_OUTPUT
                                                                                                                                                            fi
                                                                                                                                                                      if echo "$BODY" | jq -e . >/dev/null 2>&1; then
                                                                                                                                                                                  echo "$BODY" > health-report.json
                                                                                                                                                                                            else
                                                                                                                                                                                                        echo '{"status":"error","http_code":"'"$HTTP_CODE"'","error_message":"API returned non-JSON","checks":{"database":{"status":"unknown"},"api":{"status":"unhealthy"}}}' > health-report.json
                                                                                                                                                                                                                  fi
                                                                                                                                                                                                                  
                                                                                                                                                                                                                        - name: Parse Health Status
                                                                                                                                                                                                                                if: always()
                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                  if [ -f health-report.json ]; then
                                                                                                                                                                                                                                                              echo "=== Health Report ==="
                                                                                                                                                                                                                                                                          cat health-report.json | jq '.' 2>/dev/null || cat health-report.json
                                                                                                                                                                                                                                                                                    fi
                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                          - name: Check Database Connectivity
                                                                                                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                                                                                                            if [ -f health-report.json ] && jq -e . health-report.json >/dev/null 2>&1; then
                                                                                                                                                                                                                                                                                                                        STATUS=$(jq -r '.checks.database.status // "unknown"' health-report.json)
                                                                                                                                                                                                                                                                                                                                  else
                                                                                                                                                                                                                                                                                                                                              STATUS="unknown"
                                                                                                                                                                                                                                                                                                                                                        fi
                                                                                                                                                                                                                                                                                                                                                                  echo "Database Status: $STATUS"
                                                                                                                                                                                                                                                                                                                                                                            if [ "$STATUS" != "healthy" ]; then
                                                                                                                                                                                                                                                                                                                                                                                        echo "::warning::Database health check returned: $STATUS"
                                                                                                                                                                                                                                                                                                                                                                                                  fi
                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                        - name: Upload Health Report
                                                                                                                                                                                                                                                                                                                                                                                                                uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                        if: always()
                                                                                                                                                                                                                                                                                                                                                                                                                                with:
                                                                                                                                                                                                                                                                                                                                                                                                                                          name: health-report-${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                    path: health-report.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                              retention-days: 30
                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Notify on Failure
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if: steps.health.outputs.status == 'unhealthy'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "::error::Health check failed! Status: ${{ steps.health.outputs.status }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        exit 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          performance-check:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              name: Performance Metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            - name: Measure Response Times
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "=== Performance Metrics ==="
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        HEALTH_TIME=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 "${{ env.PRODUCTION_URL }}/api/health" 2>/dev/null || echo "timeout")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  echo "Health endpoint: ${HEALTH_TIME}s"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            HOME_TIME=$(curl -s -o /dev/null -w "%{time_total}" --max-time 30 "${{ env.PRODUCTION_URL }}" 2>/dev/null || echo "timeout")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      echo "Homepage: ${HOME_TIME}s"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                echo '{"health":"'"$HEALTH_TIME"'","homepage":"'"$HOME_TIME"'","timestamp":"'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"}' > performance-metrics.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Upload Performance Metrics
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              uses: actions/upload-artifact@v4
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                name: performance-metrics-${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          path: performance-metrics.json
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    retention-days: 30
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ssl-check:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          name: SSL Certificate Check
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              runs-on: ubuntu-latest
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  steps:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - name: Check SSL Expiry
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          DOMAIN="unite-hub.vercel.app"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    EXPIRY=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate 2>/dev/null | cut -d= -f2 || echo "unknown")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if [ "$EXPIRY" = "unknown" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo "::warning::Could not determine SSL certificate expiry"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s 2>/dev/null || echo "0")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    NOW_EPOCH=$(date +%s)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if [ "$EXPIRY_EPOCH" = "0" ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo "::warning::Could not parse SSL certificate expiry date"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      exit 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "SSL Certificate expires: $EXPIRY"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "Days remaining: $DAYS_LEFT"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if [ $DAYS_LEFT -lt 30 ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "::warning::SSL certificate expires in less than 30 days!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              fi
