name: Nightly Health Check

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:

env:
  PRODUCTION_URL: https://unite-hub.vercel.app

jobs:
  health-check:
    name: System Health Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check API Health
        id: health
        run: |
          RESPONSE=$(curl -s -w "\n%{http_code}" "${{ env.PRODUCTION_URL }}/api/health" || echo "FAILED")
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "status=healthy" >> $GITHUB_OUTPUT
          else
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

          echo "$BODY" > health-report.json

      - name: Parse Health Status
        if: always()
        run: |
          if [ -f health-report.json ]; then
            echo "=== Health Report ==="
            cat health-report.json | jq '.' || cat health-report.json
          fi

      - name: Check Database Connectivity
        run: |
          STATUS=$(cat health-report.json | jq -r '.checks.database.status // "unknown"')
          echo "Database Status: $STATUS"
          if [ "$STATUS" != "healthy" ]; then
            echo "::warning::Database health check failed"
          fi

      - name: Upload Health Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: health-report-${{ github.run_number }}
          path: health-report.json
          retention-days: 30

      - name: Notify on Failure
        if: steps.health.outputs.status == 'unhealthy'
        run: |
          echo "::error::Health check failed! Status: ${{ steps.health.outputs.status }}"
          exit 1

  performance-check:
    name: Performance Metrics
    runs-on: ubuntu-latest
    steps:
      - name: Measure Response Times
        run: |
          echo "=== Performance Metrics ==="

          # Health endpoint
          HEALTH_TIME=$(curl -s -o /dev/null -w "%{time_total}" "${{ env.PRODUCTION_URL }}/api/health")
          echo "Health endpoint: ${HEALTH_TIME}s"

          # Homepage
          HOME_TIME=$(curl -s -o /dev/null -w "%{time_total}" "${{ env.PRODUCTION_URL }}")
          echo "Homepage: ${HOME_TIME}s"

          # Save metrics
          echo "{\"health\": $HEALTH_TIME, \"homepage\": $HOME_TIME, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" > performance-metrics.json

      - name: Upload Performance Metrics
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics-${{ github.run_number }}
          path: performance-metrics.json
          retention-days: 30

  ssl-check:
    name: SSL Certificate Check
    runs-on: ubuntu-latest
    steps:
      - name: Check SSL Expiry
        run: |
          DOMAIN="unite-hub.vercel.app"
          EXPIRY=$(echo | openssl s_client -servername $DOMAIN -connect $DOMAIN:443 2>/dev/null | openssl x509 -noout -enddate | cut -d= -f2)
          EXPIRY_EPOCH=$(date -d "$EXPIRY" +%s)
          NOW_EPOCH=$(date +%s)
          DAYS_LEFT=$(( ($EXPIRY_EPOCH - $NOW_EPOCH) / 86400 ))

          echo "SSL Certificate expires: $EXPIRY"
          echo "Days remaining: $DAYS_LEFT"

          if [ $DAYS_LEFT -lt 30 ]; then
            echo "::warning::SSL certificate expires in less than 30 days!"
          fi
