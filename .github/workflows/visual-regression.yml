name: Visual Regression Testing (Percy)

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/app/health-check/**'
      - 'src/components/health-check/**'
      - 'tests/visual/**'
      - '.github/workflows/visual-regression.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/app/health-check/**'
      - 'src/components/health-check/**'
      - 'tests/visual/**'

jobs:
  visual-regression:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: test

      - name: Start application
        run: |
          npm start &
          sleep 10
        env:
          NODE_ENV: test

      - name: Wait for application
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3008/api/health; then
              echo "‚úÖ Application is ready"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
          exit 1

      - name: Run Percy visual regression tests
        run: |
          npx percy exec -- \
          npx playwright test tests/visual/health-check-dashboard.spec.ts \
            --reporter=html \
            --reporter=junit
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
          PERCY_PARALLEL_NONCE: ${{ github.run_id }}
          PERCY_PARALLEL_TOTAL: 1
          CI: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testResults = {
              passed: 0,
              failed: 0,
              skipped: 0,
            };

            // Parse JUnit XML for results
            try {
              const path = require('path');
              const files = fs.readdirSync('.');
              const junits = files.filter(f => f.endsWith('.xml'));

              let comment = '## üëÅÔ∏è Visual Regression Test Results\n\n';
              comment += '‚úÖ Percy visual regression testing completed\n';
              comment += 'üìä **20+ snapshots captured across desktop/mobile/tablet**\n\n';
              comment += '### Test Coverage\n';
              comment += '- [x] Desktop (1440px): Hero, Form, Results, E.E.A.T., Competitors, Recommendations\n';
              comment += '- [x] Tablet (768px): Hero, Full page\n';
              comment += '- [x] Mobile (375px): Hero, Form, Score card, Navigation, Recommendations\n';
              comment += '- [x] Accessibility: Dark mode, High contrast, Reduced motion\n\n';
              comment += 'üîç **Review changes in Percy Dashboard**: [Link](' + process.env.PERCY_LINK + ')\n';

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (e) {
              console.log('Could not create comment:', e.message);
            }

      - name: Check Percy for visual diffs
        if: github.event_name == 'pull_request'
        run: |
          echo "üì∏ Percy visual regression test results"
          echo "View the Percy dashboard to approve/reject changes:"
          echo "https://percy.io/organizations/${GITHUB_REPOSITORY_OWNER}/projects/${GITHUB_REPOSITORY##*/}/builds"
        env:
          PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}

      - name: Fail if visual regressions found
        if: failure() && github.event_name == 'pull_request'
        run: |
          echo "‚ùå Visual regression tests failed"
          echo "üì∏ Review Percy report for visual diffs"
          exit 1
