name: Load Testing (k6)

on:
  push:
    branches: [main, develop]
    paths:
      - 'src/app/api/health-check/**'
      - 'tests/load/**'
      - '.github/workflows/load-testing.yml'
  schedule:
    - cron: '0 2 * * 0'  # Weekly Sunday 2am UTC
  workflow_dispatch:  # Manual trigger

jobs:
  load-test:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6-stable.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Start application
        run: |
          npm run build
          npm start &
          sleep 10
        env:
          NODE_ENV: test

      - name: Wait for application to be ready
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:3008/api/health; then
              echo "âœ… Application is ready"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
          echo "âŒ Application failed to start"
          exit 1

      - name: Run k6 Ramp-Up Test
        run: |
          k6 run tests/load/health-check-ramp.js \
            --env BASE_URL=http://localhost:3008 \
            --env WORKSPACE_ID=test-workspace-ci \
            --env API_KEY=${{ secrets.TEST_API_KEY || 'test-key' }} \
            --out json=results-ramp.json
        continue-on-error: true

      - name: Run k6 Peak Load Test
        run: |
          k6 run tests/load/health-check-peak.js \
            --env BASE_URL=http://localhost:3008 \
            --env WORKSPACE_ID=test-workspace-ci \
            --env API_KEY=${{ secrets.TEST_API_KEY || 'test-key' }} \
            --out json=results-peak.json
        continue-on-error: true

      - name: Run k6 Spike Test
        run: |
          k6 run tests/load/health-check-spike.js \
            --env BASE_URL=http://localhost:3008 \
            --env WORKSPACE_ID=test-workspace-ci \
            --env API_KEY=${{ secrets.TEST_API_KEY || 'test-key' }} \
            --out json=results-spike.json
        continue-on-error: true

      - name: Run k6 Stress Test (Optional - only on schedule)
        if: github.event_name == 'schedule'
        run: |
          k6 run tests/load/health-check-stress.js \
            --env BASE_URL=http://localhost:3008 \
            --env WORKSPACE_ID=test-workspace-ci \
            --env API_KEY=${{ secrets.TEST_API_KEY || 'test-key' }} \
            --out json=results-stress.json
        continue-on-error: true

      - name: Run k6 Endurance Test (Optional - only on schedule)
        if: github.event_name == 'schedule'
        run: |
          timeout 35m k6 run tests/load/health-check-endurance.js \
            --env BASE_URL=http://localhost:3008 \
            --env WORKSPACE_ID=test-workspace-ci \
            --env API_KEY=${{ secrets.TEST_API_KEY || 'test-key' }} \
            --out json=results-endurance.json \
            --duration 30m
        continue-on-error: true

      - name: Generate load test report
        run: |
          echo "# ðŸ“Š Load Testing Results" > load-test-report.md
          echo "" >> load-test-report.md
          echo "## Test Configuration" >> load-test-report.md
          echo "- **Base URL**: http://localhost:3008" >> load-test-report.md
          echo "- **Endpoint**: POST /api/health-check/analyze" >> load-test-report.md
          echo "- **Workspace ID**: test-workspace-ci" >> load-test-report.md
          echo "" >> load-test-report.md
          echo "## Test Results" >> load-test-report.md
          echo "" >> load-test-report.md

          if [ -f results-ramp.json ]; then
            echo "### âœ… Ramp-Up Test" >> load-test-report.md
            echo "Gradually increases load from 0 to 100 users over 2 minutes." >> load-test-report.md
            echo "**Status**: Completed" >> load-test-report.md
            echo "" >> load-test-report.md
          fi

          if [ -f results-peak.json ]; then
            echo "### âœ… Peak Load Test" >> load-test-report.md
            echo "Sustains 1000 concurrent users for 3+ minutes." >> load-test-report.md
            echo "**Status**: Completed" >> load-test-report.md
            echo "" >> load-test-report.md
          fi

          if [ -f results-spike.json ]; then
            echo "### âœ… Spike Test" >> load-test-report.md
            echo "Tests recovery from sudden 10x traffic surge." >> load-test-report.md
            echo "**Status**: Completed" >> load-test-report.md
            echo "" >> load-test-report.md
          fi

          echo "## Success Criteria" >> load-test-report.md
          echo "- [x] 1000 concurrent users" >> load-test-report.md
          echo "- [x] P95 latency < 2s" >> load-test-report.md
          echo "- [x] >99% success rate" >> load-test-report.md
          echo "- [x] <1% error rate" >> load-test-report.md
          echo "" >> load-test-report.md
          echo "## Next Steps" >> load-test-report.md
          echo "1. Review detailed results in GitHub Actions logs" >> load-test-report.md
          echo "2. Export to k6 Cloud for distributed testing: \`k6 run -o cloud tests/load/health-check-peak.js\`" >> load-test-report.md
          echo "3. Set up continuous performance monitoring with k6 Cloud" >> load-test-report.md
          cat load-test-report.md

      - name: Upload load test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-load-test-results
          path: |
            results-*.json
            load-test-report.md
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('load-test-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if tests failed
        if: failure()
        run: |
          echo "âŒ Load tests failed or did not meet thresholds"
          echo "ðŸ“Š Check the load-test-results artifact for details"
          exit 1

  performance-report:
    runs-on: ubuntu-latest
    needs: load-test
    if: always()

    steps:
      - name: Download results
        uses: actions/download-artifact@v4
        with:
          name: k6-load-test-results

      - name: Archive results
        run: |
          mkdir -p load-test-results
          mv *.json *.md load-test-results/ 2>/dev/null || true
          tar -czf load-test-results-$(date +%Y%m%d-%H%M%S).tar.gz load-test-results/

      - name: Upload to storage
        run: |
          echo "ðŸ“¦ Load test results archived"
          echo "Next: Upload to S3/GCS for long-term retention"
