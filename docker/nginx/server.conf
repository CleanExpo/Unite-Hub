# Nginx Server Configuration for Blue-Green Deployment
# Generated: 2025-12-02
# Purpose: Main server block with health checks and proxy configuration

# HTTP server (redirect to HTTPS in production)
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    # Allow .well-known for Let's Encrypt certificate validation
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Health check endpoint (always available, never redirected)
    location /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"healthy","timestamp":"$time_iso8601","server":"$hostname"}';
    }

    # Redirect all other HTTP traffic to HTTPS (uncomment in production)
    # location / {
    #     return 301 https://$host$request_uri;
    # }

    # For local development, proxy to active upstream
    location / {
        proxy_pass http://active-app;
        proxy_http_version 1.1;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Connection reuse
        proxy_set_header Connection "";

        # Error handling
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
    }
}

# HTTPS server
server {
    listen 443 ssl http2 default_server;
    listen [::]:443 ssl http2 default_server;

    server_name _;

    # SSL configuration (adjust paths in production)
    ssl_certificate /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;

    # SSL protocols and ciphers
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # SSL session cache
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;

    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Health check endpoint (always available)
    location /health {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"healthy","timestamp":"$time_iso8601","server":"$hostname","protocol":"https"}';
    }

    # Blue environment health check (for monitoring)
    location /health/blue {
        access_log off;
        proxy_pass http://health-check-blue/health;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Green environment health check (for monitoring)
    location /health/green {
        access_log off;
        proxy_pass http://health-check-green/health;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
    }

    # Main application traffic (proxied to active upstream)
    location / {
        proxy_pass http://active-app;
        proxy_http_version 1.1;

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;

        # Connection reuse (critical for keepalive)
        proxy_set_header Connection "";

        # Error handling
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;

        # Client settings
        client_max_body_size 10M;
        client_body_buffer_size 128k;
    }

    # Static assets caching (if served by nginx)
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://active-app;
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Cache headers
        expires 7d;
        add_header Cache-Control "public, immutable";
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# Configuration notes:

# Connection Reuse:
# - proxy_set_header Connection "" enables HTTP/1.1 keepalive to upstream
# - Requires upstream keepalive directive (defined in upstream.conf)
# - Significantly improves performance (reduces connection overhead)

# Timeouts:
# - proxy_connect_timeout: Max time to establish connection to upstream
# - proxy_send_timeout: Max time for transmitting request to upstream
# - proxy_read_timeout: Max time for reading response from upstream
# - All timeouts set to reasonable values for web applications

# Error Handling:
# - proxy_next_upstream: Conditions that trigger retry on another upstream server
# - proxy_next_upstream_tries: Maximum number of retry attempts
# - Prevents cascading failures and improves availability

# Health Checks:
# - /health: Nginx-level health check (always returns 200)
# - /health/blue: Proxied to blue environment's health endpoint
# - /health/green: Proxied to green environment's health endpoint
# - All health checks have access_log off to reduce noise

# Security Headers:
# - Strict-Transport-Security: Enforce HTTPS for 1 year
# - X-Frame-Options: Prevent clickjacking attacks
# - X-Content-Type-Options: Prevent MIME sniffing
# - X-XSS-Protection: Enable browser XSS protection

# Blue-Green Deployment:
# - active-app upstream points to either blue or green
# - Traffic automatically routed to active environment
# - Zero-downtime switch via nginx reload (SIGHUP)
# - Both environments always available for health checks
