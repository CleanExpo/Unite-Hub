# Nginx Upstream Configuration for Blue-Green Deployment
# Generated: 2025-12-02
# Purpose: Define upstream server groups for blue/green environments

# Blue environment upstream
upstream app-blue {
    # Blue container running on port 3008 internally
    server app-blue:3008 max_fails=3 fail_timeout=30s;

    # Keep connections alive for reuse
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# Green environment upstream
upstream app-green {
    # Green container running on port 3008 internally
    server app-green:3008 max_fails=3 fail_timeout=30s;

    # Keep connections alive for reuse
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# Dynamic active upstream configuration
# This file is generated by deployment scripts and determines which
# upstream (blue or green) receives production traffic
#
# Format of active-upstream.conf:
# upstream active-app {
#     server app-blue:3008;  # OR app-green:3008
#     keepalive 32;
# }
#
# The deployment script writes this file and triggers nginx reload
include /etc/nginx/conf.d/active-upstream.conf;

# Upstream configuration notes:
# - max_fails=3: Mark server as unavailable after 3 failed attempts
# - fail_timeout=30s: How long to consider server unavailable
# - keepalive=32: Maintain 32 idle keepalive connections to upstream
# - keepalive_requests=100: Max requests per keepalive connection
# - keepalive_timeout=60s: How long to keep idle connections open

# Health check upstream (always available, not affected by blue-green)
# Both blue and green respond to health checks independently
upstream health-check-blue {
    server app-blue:3008;
    keepalive 8;
}

upstream health-check-green {
    server app-green:3008;
    keepalive 8;
}

# Load balancing notes:
# - Default is round-robin (not needed for single-server upstreams)
# - For multiple servers, add: least_conn; or ip_hash; directives
# - Current setup: single server per upstream (blue OR green active)

# Connection reuse benefits:
# - Reduces TCP handshake overhead
# - Improves response time (10-50ms savings per request)
# - Reduces server resource usage
# - Critical for high-throughput applications

# Failure handling:
# - Failed requests automatically retried on other servers (if multiple)
# - Health checks run every fail_timeout period
# - Server marked down after max_fails consecutive failures
# - Automatic recovery after fail_timeout expires

# Blue-green deployment flow:
# 1. Both blue and green upstreams always defined
# 2. active-upstream.conf points to current production (e.g., blue)
# 3. Deploy new version to inactive environment (e.g., green)
# 4. Run health checks on green
# 5. Update active-upstream.conf to point to green
# 6. Reload nginx with SIGHUP (zero-downtime)
# 7. Green now serves production traffic
# 8. Blue becomes inactive, ready for next deployment

# Zero-downtime reload process:
# - SIGHUP signal triggers graceful reload
# - New worker processes start with updated config
# - Old workers finish existing requests (up to 60s grace period)
# - Old workers shut down after requests complete
# - No dropped connections or failed requests
