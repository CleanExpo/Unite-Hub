version: '3.8'

# Blue-Green Deployment Configuration
# Generated: 2025-12-02
# Purpose: Docker Compose setup for zero-downtime blue-green deployments

services:
  # ======================================================================
  # APPLICATION SERVICES (Blue-Green Environments)
  # ======================================================================

  # Blue environment - Primary deployment slot
  app-blue:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    container_name: unite-hub-app-blue
    ports:
      - "3009:3008"  # External:Internal (for direct access if needed)
    environment:
      - NODE_ENV=production
      - PORT=3008
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - EMAIL_SERVER_HOST=${EMAIL_SERVER_HOST}
      - EMAIL_SERVER_PORT=${EMAIL_SERVER_PORT}
      - EMAIL_SERVER_USER=${EMAIL_SERVER_USER}
      - EMAIL_SERVER_PASSWORD=${EMAIL_SERVER_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - app-network
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3008/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      - "deployment=blue"
      - "environment=production"
      - "service=unite-hub-app"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # Green environment - Secondary deployment slot
  app-green:
    build:
      context: .
      dockerfile: Dockerfile
      target: runner
    container_name: unite-hub-app-green
    ports:
      - "3010:3008"  # External:Internal (for direct access if needed)
    environment:
      - NODE_ENV=production
      - PORT=3008
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - EMAIL_SERVER_HOST=${EMAIL_SERVER_HOST}
      - EMAIL_SERVER_PORT=${EMAIL_SERVER_PORT}
      - EMAIL_SERVER_USER=${EMAIL_SERVER_USER}
      - EMAIL_SERVER_PASSWORD=${EMAIL_SERVER_PASSWORD}
      - EMAIL_FROM=${EMAIL_FROM}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - RESEND_API_KEY=${RESEND_API_KEY}
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=${DATABASE_URL}
    networks:
      - app-network
    depends_on:
      - redis
      - postgres
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3008/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    labels:
      - "deployment=green"
      - "environment=production"
      - "service=unite-hub-app"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # ======================================================================
  # NGINX REVERSE PROXY
  # ======================================================================

  nginx:
    image: nginx:1.25-alpine
    container_name: unite-hub-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Nginx configuration files
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/upstream.conf:/etc/nginx/conf.d/upstream.conf:ro
      - ./docker/nginx/server.conf:/etc/nginx/conf.d/server.conf:ro

      # Dynamic upstream configuration (generated by deployment scripts)
      - ./docker/nginx/active-upstream.conf:/etc/nginx/conf.d/active-upstream.conf:ro

      # SSL certificates (mount from host or Let's Encrypt)
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro

      # Let's Encrypt webroot (for certificate validation)
      - ./docker/nginx/certbot:/var/www/certbot:ro

      # Reload script
      - ./docker/nginx/reload.sh:/usr/local/bin/nginx-reload.sh:ro

      # Logs
      - nginx-logs:/var/log/nginx
    networks:
      - app-network
    depends_on:
      - app-blue
      - app-green
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "service=nginx"
      - "role=reverse-proxy"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ======================================================================
  # SHARED SERVICES (Used by both Blue and Green)
  # ======================================================================

  # Redis cache and session store
  redis:
    image: redis:7-alpine
    container_name: unite-hub-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    labels:
      - "service=redis"
      - "role=cache"
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # PostgreSQL database (if not using Supabase cloud)
  postgres:
    image: postgres:16-alpine
    container_name: unite-hub-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-unite_hub}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./supabase/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "service=postgres"
      - "role=database"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

# ======================================================================
# NETWORKS
# ======================================================================

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ======================================================================
# VOLUMES
# ======================================================================

volumes:
  redis-data:
    driver: local
  postgres-data:
    driver: local
  nginx-logs:
    driver: local

# ======================================================================
# DEPLOYMENT NOTES
# ======================================================================

# Blue-Green Deployment Workflow:
#
# 1. Initial Setup (Blue Active):
#    - docker-compose -f docker-compose.blue-green.yml up -d
#    - Create active-upstream.conf pointing to app-blue
#    - Both blue and green containers running
#    - Nginx routes traffic to blue
#
# 2. Deploy New Version to Green:
#    - docker-compose -f docker-compose.blue-green.yml build app-green
#    - docker-compose -f docker-compose.blue-green.yml up -d app-green
#    - Wait for green health checks to pass
#    - Verify green is working (curl http://localhost:3010/health)
#
# 3. Switch Traffic to Green:
#    - Update active-upstream.conf to point to app-green
#    - docker-compose -f docker-compose.blue-green.yml exec nginx nginx-reload.sh
#    - Nginx reloads with zero downtime
#    - Traffic now flows to green
#
# 4. Verify Green in Production:
#    - Monitor logs and metrics
#    - Check /health endpoint
#    - Verify application functionality
#
# 5. Rollback (if needed):
#    - Update active-upstream.conf back to app-blue
#    - docker-compose -f docker-compose.blue-green.yml exec nginx nginx-reload.sh
#    - Traffic instantly switches back to blue
#
# 6. Clean Up Blue and Prepare for Next Deployment:
#    - Blue is now idle
#    - Next deployment goes to blue
#    - Repeat cycle

# Resource Allocation:
# - app-blue: 1-2 CPU cores, 1-2GB RAM
# - app-green: 1-2 CPU cores, 1-2GB RAM
# - nginx: 0.5-1 CPU cores, 256-512MB RAM
# - redis: 0.25-1 CPU cores, 256-512MB RAM
# - postgres: 0.5-2 CPU cores, 512MB-2GB RAM
# Total: ~6-8 CPU cores, 4-8GB RAM

# Health Check Strategy:
# - All services have health checks
# - Nginx health: Configuration test (nginx -t)
# - App health: HTTP /health endpoint
# - Redis health: PING command
# - Postgres health: pg_isready check
# - Health checks run every 10-30s

# Network Configuration:
# - Single bridge network (app-network)
# - Subnet: 172.28.0.0/16
# - Internal DNS resolution (service names)
# - Blue and green share network with shared services

# Volume Persistence:
# - redis-data: Redis persistence (AOF enabled)
# - postgres-data: PostgreSQL data directory
# - nginx-logs: Nginx access and error logs
# - All volumes are local (use cloud volumes in production)

# Security Considerations:
# - All config files mounted read-only (:ro)
# - SSL certificates in separate directory
# - Environment variables passed through from .env
# - Health checks don't expose sensitive data
# - Nginx denies access to hidden files
