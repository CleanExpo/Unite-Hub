# üöÄ Run Migration 042 - Extend Generated Content

**Migration**: `042_extend_generated_content.sql`
**Purpose**: Add support for new content types and strategy fields
**Status**: ‚è≥ Ready to Execute

---

## ‚úÖ What This Migration Does

### 1. Extends `generated_content` Table
- **Adds new content types**: `blog_post`, `email`, `social_post`, `other`
- **Previous types preserved**: `followup`, `proposal`, `case_study`
- **Total content types**: 7

### 2. Extends `marketing_strategies` Table
Adds 5 new JSONB columns:
- `full_strategy` - Complete strategy document
- `brand_positioning` - UVP, differentiators, voice, personality
- `budget_allocation` - Budget breakdown by category
- `kpis` - Array of KPI objects with metrics and targets
- `risks` - Array of risk objects with mitigation plans

### 3. Extends `calendar_posts` Table
Adds 3 new columns for social media integration:
- `engagement_metrics` (JSONB) - Likes, shares, comments from platform APIs
- `platform_post_id` (TEXT) - External platform post ID (e.g., LinkedIn post ID)
- `platform_url` (TEXT) - Public URL of published post

### 4. Creates Indexes
- GIN indexes on `full_strategy` and `kpis` for fast JSONB queries
- B-tree index on `platform_post_id` for lookups

---

## üéØ Quick Execution (60 Seconds)

### Option A: Supabase Dashboard (Recommended)

1. **Open SQL Editor**:
   ```
   https://supabase.com/dashboard/project/lksfwktwtmyznckodsau/editor/sql
   ```

2. **Click "New query"**

3. **Copy/paste entire file**:
   ```
   d:\Unite-Hub\supabase\migrations\042_extend_generated_content.sql
   ```

4. **Click "Run" ‚ñ∂Ô∏è**

5. **Wait for success message**:
   ```
   ‚úÖ Migration 041 Complete!
   üìä generated_content: Extended content types constraint
   üìä marketing_strategies: Added 5 columns
   üìä calendar_posts: Added 3 columns
   ‚ú® SUCCESS: All extensions applied!
   ```

---

## üìä Verification

### Check New Content Types

```sql
-- Query the constraint to see allowed content types
SELECT conname, pg_get_constraintdef(oid)
FROM pg_constraint
WHERE conname = 'generated_content_content_type_check';

-- Expected: followup, proposal, case_study, blog_post, email, social_post, other
```

### Check New Columns in marketing_strategies

```sql
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_name = 'marketing_strategies'
AND column_name IN ('full_strategy', 'brand_positioning', 'budget_allocation', 'kpis', 'risks')
ORDER BY column_name;

-- Expected: 5 rows
```

### Check New Columns in calendar_posts

```sql
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'calendar_posts'
AND column_name IN ('engagement_metrics', 'platform_post_id', 'platform_url')
ORDER BY column_name;

-- Expected: 3 rows
```

### Check Indexes Created

```sql
SELECT indexname, tablename, indexdef
FROM pg_indexes
WHERE indexname IN (
  'idx_marketing_strategies_full_strategy',
  'idx_marketing_strategies_kpis',
  'idx_calendar_posts_platform_post_id'
)
ORDER BY indexname;

-- Expected: 3 rows
```

---

## üîÑ Force Schema Cache Refresh (If Needed)

After migration, wait 60 seconds OR run:

```bash
node refresh-supabase-schema.mjs
```

Then query the tables:

```sql
-- Test full_strategy column
SELECT id, full_strategy FROM marketing_strategies LIMIT 1;

-- Test engagement_metrics column
SELECT id, engagement_metrics FROM calendar_posts LIMIT 1;

-- Test new content types
INSERT INTO generated_content (
  workspace_id,
  contact_id,
  content_type,
  generated_text,
  prompt_used
) VALUES (
  'your-workspace-id',
  'your-contact-id',
  'blog_post',  -- NEW type
  'Test blog post content',
  'Generate blog post'
);
```

---

## üß™ Test New Functionality

### 1. Test New Content Type

```sql
-- Insert a blog post (new type)
INSERT INTO generated_content (
  workspace_id,
  contact_id,
  content_type,
  generated_text,
  prompt_used,
  ai_model_used,
  status
) VALUES (
  'kh72b1cng9h88691sx4x7krt2h7v7deh',
  (SELECT id FROM contacts LIMIT 1),
  'blog_post',
  'This is a test blog post generated by Claude AI.',
  'Generate engaging blog post about marketing automation',
  'claude-sonnet-4-5-20250929',
  'draft'
)
RETURNING id, content_type, created_at;
```

### 2. Test marketing_strategies Extensions

```sql
-- Update strategy with full data
UPDATE marketing_strategies
SET
  full_strategy = '{
    "executive_summary": "Comprehensive 90-day growth strategy",
    "objectives": ["Increase brand awareness", "Generate qualified leads"],
    "target_personas": [{"name": "Marketing Manager", "industry": "SaaS"}]
  }'::jsonb,
  brand_positioning = '{
    "unique_value_proposition": "AI-first CRM that works for you",
    "differentiators": ["Autonomous agents", "Extended thinking"],
    "brand_voice": "Professional yet approachable",
    "brand_personality": ["Innovative", "Reliable", "Empowering"]
  }'::jsonb,
  budget_allocation = '{
    "content_creation": 5000,
    "paid_advertising": 10000,
    "tools_and_software": 2000,
    "team_resources": 8000
  }'::jsonb,
  kpis = '[
    {"metric": "Website Traffic", "baseline": 1000, "target": 5000, "timeframe": "90 days"},
    {"metric": "Lead Conversion Rate", "baseline": 2.5, "target": 5.0, "timeframe": "90 days"}
  ]'::jsonb,
  risks = '[
    {"risk": "Budget constraints", "likelihood": "medium", "impact": "high", "mitigation": "Prioritize organic channels"},
    {"risk": "Market saturation", "likelihood": "low", "impact": "medium", "mitigation": "Focus on unique differentiators"}
  ]'::jsonb
WHERE id = (SELECT id FROM marketing_strategies LIMIT 1)
RETURNING id, created_at;
```

### 3. Test calendar_posts Extensions

```sql
-- Simulate published post with engagement
UPDATE calendar_posts
SET
  status = 'published',
  platform_post_id = 'urn:li:share:1234567890',
  platform_url = 'https://www.linkedin.com/posts/unite-group_1234567890',
  engagement_metrics = '{
    "likes": 42,
    "comments": 8,
    "shares": 12,
    "impressions": 1250,
    "engagement_rate": 4.96,
    "last_updated": "2025-11-18T12:00:00Z"
  }'::jsonb
WHERE id = (SELECT id FROM calendar_posts LIMIT 1)
RETURNING id, platform, platform_url, engagement_metrics;
```

---

## üìã Migration Dependencies

### Required Tables (Must exist before running):
- ‚úÖ `generated_content` - Created in previous migration
- ‚úÖ `marketing_strategies` - Created in previous migration
- ‚úÖ `calendar_posts` - Created in previous migration

### Related Migrations:
- Migration 037: RLS policy cleanup
- Migration 038: Core SaaS tables
- Migration 040: Add intelligence tracking
- Migration 041: Create client_emails table
- **Migration 042**: Extend generated content (THIS ONE)
- Migration 100: Multi-agent system infrastructure

---

## üö® Rollback (If Needed)

If migration fails or needs to be reverted:

```sql
-- 1. Drop new indexes
DROP INDEX IF EXISTS idx_marketing_strategies_full_strategy;
DROP INDEX IF EXISTS idx_marketing_strategies_kpis;
DROP INDEX IF EXISTS idx_calendar_posts_platform_post_id;

-- 2. Remove new columns from marketing_strategies
ALTER TABLE marketing_strategies
DROP COLUMN IF EXISTS full_strategy,
DROP COLUMN IF EXISTS brand_positioning,
DROP COLUMN IF EXISTS budget_allocation,
DROP COLUMN IF EXISTS kpis,
DROP COLUMN IF EXISTS risks;

-- 3. Remove new columns from calendar_posts
ALTER TABLE calendar_posts
DROP COLUMN IF EXISTS engagement_metrics,
DROP COLUMN IF EXISTS platform_post_id,
DROP COLUMN IF EXISTS platform_url;

-- 4. Revert generated_content constraint
ALTER TABLE generated_content DROP CONSTRAINT IF EXISTS generated_content_content_type_check;
ALTER TABLE generated_content
ADD CONSTRAINT generated_content_content_type_check
CHECK (content_type IN ('followup', 'proposal', 'case_study'));
```

---

## ‚úÖ Post-Migration Checklist

After successful migration:

- [ ] Verify 7 content types in generated_content constraint
- [ ] Verify 5 new columns in marketing_strategies
- [ ] Verify 3 new columns in calendar_posts
- [ ] Verify 3 new indexes created
- [ ] Test inserting new content type (blog_post)
- [ ] Test querying full_strategy JSONB
- [ ] Test updating engagement_metrics
- [ ] Wait 60 seconds for schema cache refresh
- [ ] Run `node refresh-supabase-schema.mjs`
- [ ] Update agents to use new fields

---

## üéØ Impact on Agents

### Content Agent (content-agent.mjs)
**Updates Needed**:
- Use new content types: `blog_post`, `email`, `social_post`
- Store richer data in generated_content

### Content Calendar Agent (NEW)
**Can Now**:
- Store engagement metrics from social platforms
- Track published post URLs
- Link calendar posts to external platforms

### Strategy Agent (strategy-agent.mjs)
**Can Now**:
- Store complete strategy in `full_strategy` column
- Define brand positioning
- Allocate budget by category
- Set KPIs with baselines and targets
- Identify and mitigate risks

---

## üí° Usage Examples

### Generate Blog Post (Content Agent)

```typescript
const { data, error } = await supabase
  .from('generated_content')
  .insert({
    workspace_id: workspaceId,
    contact_id: contactId,
    content_type: 'blog_post', // NEW
    generated_text: blogPostContent,
    prompt_used: `Generate engaging blog post about: ${topic}`,
    ai_model_used: 'claude-sonnet-4-5-20250929',
    status: 'draft'
  })
  .select()
  .single();
```

### Store Complete Strategy (Strategy Agent)

```typescript
const { data, error } = await supabase
  .from('marketing_strategies')
  .update({
    full_strategy: {
      executive_summary: '...',
      objectives: [...],
      target_personas: [...],
      // ... complete strategy
    },
    brand_positioning: {
      unique_value_proposition: '...',
      differentiators: [...],
      brand_voice: '...',
      brand_personality: [...]
    },
    budget_allocation: {
      content_creation: 5000,
      paid_advertising: 10000,
      // ...
    },
    kpis: [
      { metric: 'Website Traffic', baseline: 1000, target: 5000, timeframe: '90 days' },
      // ...
    ],
    risks: [
      { risk: 'Budget constraints', likelihood: 'medium', impact: 'high', mitigation: '...' },
      // ...
    ]
  })
  .eq('id', strategyId);
```

### Track Social Engagement (Content Calendar Agent)

```typescript
// After post is published
const { data, error } = await supabase
  .from('calendar_posts')
  .update({
    status: 'published',
    platform_post_id: linkedInPostId,
    platform_url: linkedInPostUrl,
    engagement_metrics: {
      likes: 0,
      comments: 0,
      shares: 0,
      impressions: 0,
      engagement_rate: 0,
      last_updated: new Date().toISOString()
    }
  })
  .eq('id', calendarPostId);

// Later, update with real engagement data
const { data, error } = await supabase
  .from('calendar_posts')
  .update({
    engagement_metrics: {
      likes: 42,
      comments: 8,
      shares: 12,
      impressions: 1250,
      engagement_rate: 4.96,
      last_updated: new Date().toISOString()
    }
  })
  .eq('platform_post_id', linkedInPostId);
```

---

## üìä Expected Performance

**Migration Execution**: ~2-5 seconds

**Operations**:
- 1 constraint drop/recreate
- 5 column additions (marketing_strategies)
- 3 column additions (calendar_posts)
- 3 index creations
- Verification queries

**No Data Loss**: All existing data preserved, only schema extended.

---

## üéâ Ready to Execute!

**Next Step**: Open Supabase SQL Editor and run the migration!

**URL**: https://supabase.com/dashboard/project/lksfwktwtmyznckodsau/editor/sql

After execution, reply "**migration 042 done**" and I'll proceed with implementing the Content Calendar Agent!

---

**Status**: ‚è≥ Awaiting Execution
**Estimated Time**: 60 seconds
**Risk Level**: Low (adds columns, doesn't modify existing data)
