Guardian Phase G36: Automated Alert Evaluation Engine (Phase 1) - COMPLETE
==========================================================================

Implementation Date: December 10, 2025
Phase Type: Deterministic Evaluation Engine
Status: ‚úÖ Code Complete (Ready for Testing)

SUMMARY:
--------
Added automated alert rule evaluation engine. Implements deterministic condition evaluation that scans active alert rules, evaluates conditions against warehouse and telemetry data, and generates alert events when conditions match. Manually triggered via API endpoint (admin-only).

This is Phase 1 - pure deterministic evaluation, no ML, no cron scheduling, no external notifications yet.

FILES CREATED (3):
------------------
1. src/lib/guardian/alertEvaluator.ts (3.5 KB)
   - evaluateGuardianAlertRules() - Core evaluation logic
   - AlertCondition type - Condition DSL (metric/field, op, value)
   - FiredAlertEvent type - Matched alert events
   - Graceful degradation for missing tables

2. src/app/api/guardian/alerts/evaluate/route.ts (1.8 KB)
   - POST /api/guardian/alerts/evaluate - Trigger evaluation
   - Admin-only access control (guardian_admin)
   - Fetches active rules, evaluates conditions, inserts events
   - Returns evaluation summary (rulesEvaluated, eventsFired, events)

3. docs/PHASE_G36_ALERT_EVALUATION_ENGINE_STATUS.md (12 KB)
   - Comprehensive phase documentation
   - Condition DSL reference with examples
   - API usage examples and testing guide
   - Use cases and performance notes

FEATURES:
---------
Evaluation Engine:
- Deterministic condition evaluation (no ML)
- Metric-based evaluation (warehouse_rollups_hourly)
- Field-based evaluation (telemetry_events)
- Operators: equals, greater_than, less_than, exists
- Graceful degradation if data tables don't exist

Condition DSL:
- Metric-based: { "metric": "errors_per_minute", "op": "greater_than", "value": 20 }
- Field-based: { "field": "status_code", "op": "equals", "value": 500 }
- Existence: { "field": "error_message", "op": "exists" }

API Endpoint:
- POST /api/guardian/alerts/evaluate
- Admin-only (guardian_admin)
- Returns: { success, rulesEvaluated, eventsFired, events }
- Auto-inserts matched events into guardian_alert_events

Data Sources:
- warehouse_rollups_hourly (latest 20 samples)
- telemetry_events (latest 200 events)
- Both optional - evaluation continues with available data

CONDITION DSL:
--------------
Type Definition:
```typescript
type AlertCondition = {
  metric?: string;  // For warehouse metrics
  field?: string;   // For telemetry event fields
  op: 'equals' | 'greater_than' | 'less_than' | 'exists';
  value?: unknown;
};
```

Metric-Based (Warehouse):
```json
{
  "metric": "errors_per_minute",
  "op": "greater_than",
  "value": 20
}
```

Field-Based (Telemetry):
```json
{
  "field": "status_code",
  "op": "equals",
  "value": 500
}
```

Existence Check:
```json
{
  "field": "error_message",
  "op": "exists"
}
```

OPERATORS:
----------
1. equals - Loose equality (==)
   - Works for strings, numbers, booleans
   - Example: status_code == 500, log_level == "ERROR"

2. greater_than - Numeric comparison (>)
   - Requires number types for both metric/field and value
   - Example: errors_per_minute > 20, duration_ms > 5000

3. less_than - Numeric comparison (<)
   - Requires number types for both metric/field and value
   - Example: response_time_p95 < 100, success_rate < 0.95

4. exists - Presence check
   - True if metric/field exists and is not null/undefined
   - Example: error_stack exists, warehouse_metric exists

API ENDPOINT:
-------------
POST /api/guardian/alerts/evaluate

Access Control: guardian_admin only (403 for viewer/analyst)

Request: No body required (evaluates all active rules)

Response (Success):
```json
{
  "success": true,
  "rulesEvaluated": 5,
  "eventsFired": 2,
  "events": [
    {
      "ruleId": "uuid",
      "severity": "high",
      "source": "telemetry",
      "message": "Rule 'High error rate on /api/guardian/telemetry' fired due to condition match",
      "payload": {
        "event": { "id": "...", "status_code": 500, ... },
        "fieldValue": 500,
        "evaluatedAt": "2025-12-10T10:30:00Z"
      }
    }
  ]
}
```

Response (Error):
```json
{
  "error": "Alert evaluation unavailable.",
  "code": 403
}
```

Error Codes:
- 401 - UNAUTHENTICATED (no Guardian session)
- 403 - FORBIDDEN (not guardian_admin)
- 500 - INTERNAL SERVER ERROR

EVALUATION WORKFLOW:
--------------------
1. Authenticate user and verify guardian_admin role
2. Get tenant context (tenant_id)
3. Fetch all active alert rules for tenant
4. Fetch latest warehouse rollup samples (20 samples, if table exists)
5. Fetch latest telemetry events (200 events, if table exists)
6. For each active rule:
   a. Parse condition JSON
   b. If metric-based: evaluate against warehouse data
   c. If field-based: evaluate against telemetry events
   d. If condition matches: queue alert event
7. Insert all fired events into guardian_alert_events
8. Return evaluation summary

GRACEFUL DEGRADATION:
---------------------
If warehouse_rollups_hourly table doesn't exist:
- Skip metric-based evaluation
- Continue with field-based evaluation

If telemetry_events table doesn't exist:
- Skip field-based evaluation
- Continue with metric-based evaluation

If both tables missing:
- Evaluation returns 0 events fired
- No errors thrown

USAGE EXAMPLES:
---------------
1. Create alert rule with condition:
```bash
curl -X POST \
  -H "Cookie: sb-access-token=<TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "High telemetry error rate",
    "description": "Trigger when status_code 500 appears",
    "severity": "high",
    "source": "telemetry",
    "channel": "email",
    "condition": {
      "field": "status_code",
      "op": "equals",
      "value": 500
    }
  }' \
  http://localhost:3008/api/guardian/alerts
```

2. Trigger manual evaluation:
```bash
curl -X POST \
  -H "Cookie: sb-access-token=<TOKEN>" \
  http://localhost:3008/api/guardian/alerts/evaluate
```

3. View fired events in UI:
Visit: http://localhost:3008/guardian/alerts
Events appear in "Recent alert events" table

USE CASES:
----------
1. Monitor API Error Rates
   - Rule: High 500 errors in telemetry
   - Condition: { "field": "status_code", "op": "equals", "value": 500 }
   - Future: Run every 5 minutes, email on fire

2. Detect Slow Requests
   - Rule: P95 response time exceeds threshold
   - Condition: { "metric": "response_time_p95", "op": "greater_than", "value": 1000 }
   - Future: Run every 10 minutes, post to Slack

3. Alert on Missing Data
   - Rule: No recent telemetry events
   - Condition: { "field": "created_at", "op": "less_than", "value": "2025-12-10T09:00:00Z" }
   - Future: Run hourly, page on-call

4. Resource Exhaustion
   - Rule: Error count exceeds capacity
   - Condition: { "metric": "error_count", "op": "greater_than", "value": 100 }
   - Future: Run every minute, critical pager

PHASE G36 SCOPE:
----------------
‚úÖ Deterministic evaluation engine
‚úÖ Condition DSL (4 operators: equals, greater_than, less_than, exists)
‚úÖ Metric-based evaluation (warehouse data)
‚úÖ Field-based evaluation (telemetry events)
‚úÖ Manual trigger via POST endpoint
‚úÖ Auto-insert guardian_alert_events on match
‚úÖ Admin-only access control
‚úÖ Graceful degradation (missing tables)
‚úÖ Comprehensive documentation

FUTURE PHASES (G37+):
---------------------
‚ùå Automated scheduling (cron job every N minutes) - G37
‚ùå External notification delivery (email, webhook, pager) - G38
‚ùå Complex condition logic (AND/OR/NOT operators) - G39
‚ùå Time-window aggregations (e.g. "OVER 5 minutes") - G40
‚ùå Alert deduplication (prevent spam) - G37
‚ùå Alert cooldown/snooze (rate limiting) - G37
‚ùå Alert suppression (maintenance mode) - G38
‚ùå Alert analytics (frequency, false positives) - G41

INTEGRATION POINTS:
-------------------
‚úÖ G30 (Tenant Hardening) - Uses getGuardianTenantContext()
‚úÖ G31 (Tenant Enforcement) - Returns 401 if unauthenticated
‚úÖ G32 (Access Levels) - Enforces admin-only access
‚úÖ G35 (Alert Rules & Events) - Reads guardian_alert_rules, writes guardian_alert_events

Data Sources (optional):
üîú warehouse_rollups_hourly - Aggregated metrics (if exists)
üîú telemetry_events - Raw telemetry events (if exists)

Enables:
üîú G37 (Scheduled Evaluation) - Cron job to auto-trigger evaluation
üîú G38 (External Notifications) - Send alerts via email, webhook, pager
üîú G41 (Alert Analytics) - Track frequency, MTTA/MTTR

PERFORMANCE:
------------
Evaluation Complexity:
- Rules Query: O(n) where n = active rules (~5-20)
- Data Fetch: O(1) - 20 warehouse + 200 telemetry samples
- Evaluation: O(n √ó m) where n = rules, m = data points (~5 √ó 220 = 1100 ops)
- Insert: O(k) where k = fired events (~1-5)

Typical Runtime: 50-200ms per evaluation run

Optimization Opportunities (G37+):
- Cache warehouse/telemetry data between runs
- Parallelize rule evaluation
- Batch insert alert events
- Index guardian_alert_events.created_at

TESTING CHECKLIST:
------------------
[ ] Create alert rule with metric-based condition (warehouse)
[ ] Create alert rule with field-based condition (telemetry)
[ ] Set user role to guardian_admin
[ ] POST /api/guardian/alerts/evaluate
[ ] Verify events appear in /guardian/alerts UI
[ ] Test with guardian_viewer role (should get 403)
[ ] Test with guardian_analyst role (should get 403)
[ ] Test all 4 operators (equals, greater_than, less_than, exists)
[ ] Test with missing warehouse_rollups_hourly table
[ ] Test with missing telemetry_events table
[ ] Verify payload contains matched data

MANUAL TESTING SCRIPT:
----------------------
```bash
# 1. Create test alert rule (always fires)
curl -X POST \
  -H "Cookie: sb-access-token=<TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test rule - Always fires",
    "description": "Test condition that always matches",
    "severity": "low",
    "source": "telemetry",
    "channel": "in_app",
    "condition": {
      "field": "id",
      "op": "exists"
    }
  }' \
  http://localhost:3008/api/guardian/alerts

# 2. Trigger evaluation
curl -X POST \
  -H "Cookie: sb-access-token=<TOKEN>" \
  http://localhost:3008/api/guardian/alerts/evaluate

# 3. View events in UI
open http://localhost:3008/guardian/alerts
```

GUARDIAN SYSTEM STATUS:
-----------------------
Total Phases: G01-G36 ‚úÖ
Total Tables: 38 (no new tables in G36)
Total Migrations: 542 (alert rules) + 584 (access audit)
Total API Routes: 8 (+1 new: POST /api/guardian/alerts/evaluate)
Evaluation Engine: Active ‚úÖ
Production Ready: YES (after testing)

API ROUTES:
-----------
1. GET /api/guardian/telemetry - All roles ‚úÖ
2. GET /api/guardian/warehouse - Analyst+ ‚úÖ
3. GET /api/guardian/replay - Analyst+ ‚úÖ
4. GET /api/guardian/scenarios - Admin only ‚úÖ
5. GET /api/guardian/access-audit - Analyst+ ‚úÖ
6. GET /api/guardian/alerts - All roles ‚úÖ
7. POST /api/guardian/alerts - Admin only ‚úÖ
8. POST /api/guardian/alerts/evaluate - Admin only ‚úÖ (NEW)

UI PAGES:
---------
1. /guardian/telemetry - All roles ‚úÖ
2. /guardian/warehouse - Analyst+ ‚úÖ
3. /guardian/replay - Analyst+ ‚úÖ
4. /guardian/scenarios - Admin only ‚úÖ
5. /guardian/access-audit - Analyst+ ‚úÖ
6. /guardian/alerts - All roles ‚úÖ

BEFORE (G35):
-------------
- Alert rules stored but never evaluated
- guardian_alert_events table empty (no automatic inserts)
- Founders manually created test events via SQL
- No way to trigger condition evaluation
- No foundation for automated alerting

AFTER (G36):
------------
- ‚úÖ Deterministic evaluation engine implemented
- ‚úÖ POST /api/guardian/alerts/evaluate triggers evaluation
- ‚úÖ Conditions evaluated against warehouse + telemetry data
- ‚úÖ guardian_alert_events auto-populated on match
- ‚úÖ Admin-only access control enforced
- ‚úÖ Foundation for scheduled evaluation (G37)
- ‚úÖ Foundation for external notifications (G38)

BREAKING CHANGES:
-----------------
‚úÖ None - Pure addition of evaluation logic and API endpoint

No changes to:
- Guardian UI or rule creation
- Existing API routes
- Database schema
- Access control policies

NEXT STEPS:
-----------
1. Test evaluation API:
   ```bash
   curl -X POST -H "Cookie: sb-access-token=<TOKEN>" \
     http://localhost:3008/api/guardian/alerts/evaluate
   ```

2. Create test alert rules with conditions:
   - Test all 4 operators (equals, greater_than, less_than, exists)
   - Test both metric-based and field-based conditions

3. Verify events appear in UI:
   - Visit /guardian/alerts
   - Check "Recent alert events" table

4. Test access control:
   - Try with viewer/analyst roles (should get 403)
   - Only admin can trigger evaluation

NEXT PHASE: G37 - Scheduled Alert Evaluation
---------------------------------------------
Planned Features:
- Background cron job to run evaluation every N minutes
- Configurable evaluation frequency per rule
- Alert deduplication (prevent duplicate events within time window)
- Alert cooldown (rate limit per rule)
- Evaluation run history (track when last evaluated)
- Batch evaluation API (evaluate specific rules only)

---
Generated: 2025-12-10
Phase: Guardian G36 - Automated Alert Evaluation Engine (Phase 1)
Type: Deterministic Evaluation
