Guardian Phase G37: Automated Alert Scheduling Engine - COMPLETE
====================================================================

Implementation Date: December 10, 2025
Phase Type: Scheduled Evaluation System
Status: ‚úÖ Code Complete (Ready for Testing)

SUMMARY:
--------
Added automated scheduled evaluation for alert rules. Implements cron-based scheduling with per-tenant configuration, debounce windows to prevent spam, and secure cron endpoint for automated execution. Reuses G36 deterministic evaluation engine. No external notifications yet (G38).

FILES CREATED (5):
------------------
1. supabase/migrations/543_guardian_alert_schedule.sql (1.7 KB)
   - guardian_alert_schedules table (per-tenant configuration)
   - interval_minutes (1-1440, default 5)
   - debounce_minutes (1-1440, default 10)
   - last_run_at (tracks evaluation runs)
   - 2 indexes (last_run, interval+last_run)
   - 3 RLS policies (tenant read/write, service all)

2. src/lib/guardian/alertSchedulerService.ts (3.2 KB)
   - getGuardianAlertSchedule(tenantId) - Fetch schedule config
   - upsertGuardianAlertSchedule() - Create/update schedule
   - markAlertScheduleRun(tenantId) - Update last_run_at
   - getDueAlertSchedules() - Fetch all due schedules
   - GuardianAlertSchedule type

3. src/app/api/guardian/alerts/schedule/route.ts (2.4 KB)
   - GET: Fetch schedule config (admin only)
   - POST: Create/update schedule config (admin only)
   - Validates interval_minutes and debounce_minutes (1-1440)
   - Returns schedule or defaults if not configured

4. src/app/api/guardian/alerts/scheduled-run/route.ts (3.8 KB)
   - POST: Scheduled evaluation endpoint (cron-triggered)
   - Secret header authentication (x-guardian-scheduler-secret)
   - Batch evaluation across all due tenants
   - Reuses G36 evaluation engine
   - Returns evaluation summary

5. docs/PHASE_G37_ALERT_SCHEDULER_STATUS.md (15 KB)
   - Comprehensive phase documentation
   - Scheduling configuration guide
   - Cron job setup examples
   - Use cases and performance notes

FEATURES:
---------
Scheduling Configuration:
- Per-tenant scheduling (guardian_alert_schedules table)
- Interval minutes: How often to evaluate (1-1440, default 5)
- Debounce minutes: Prevent spam (1-1440, default 10)
- Last run tracking: Enforces interval + debounce logic

Admin API:
- GET /api/guardian/alerts/schedule - Fetch schedule config
- POST /api/guardian/alerts/schedule - Create/update schedule config
- Admin-only access (guardian_admin)
- Validation: interval_minutes and debounce_minutes (1-1440)

Cron Endpoint:
- POST /api/guardian/alerts/scheduled-run
- Secret header auth (x-guardian-scheduler-secret)
- No user authentication required
- Batch evaluation across all due tenants
- Reuses G36 evaluation pipeline
- Returns evaluation summary

Debounce Logic:
- Skip evaluation if: now - last_run_at < interval_minutes
- Prevents repeated evaluations within interval
- Rate-limits evaluations per tenant
- Configurable per tenant (debounce_minutes)

Evaluation Pipeline:
- Reuses evaluateGuardianAlertRules() from G36
- Fetches active rules per tenant
- Evaluates conditions against warehouse + telemetry
- Inserts fired events into guardian_alert_events
- Marks schedule as run (updates last_run_at)

DATABASE SCHEMA:
----------------
guardian_alert_schedules:
```sql
CREATE TABLE guardian_alert_schedules (
  tenant_id UUID PRIMARY KEY,
  interval_minutes INT NOT NULL DEFAULT 5 CHECK (interval_minutes >= 1 AND interval_minutes <= 1440),
  debounce_minutes INT NOT NULL DEFAULT 10 CHECK (debounce_minutes >= 1 AND debounce_minutes <= 1440),
  last_run_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

Indexes:
- idx_guardian_alert_schedules_last_run (last_run_at)
- idx_guardian_alert_schedules_interval (interval_minutes, last_run_at)

RLS Policies:
- tenant_select_guardian_alert_schedules (SELECT for tenant_id = auth.uid())
- tenant_upsert_guardian_alert_schedules (ALL for tenant_id = auth.uid())
- service_all_guardian_alert_schedules (ALL for service role)

API ENDPOINTS:
--------------
1. GET /api/guardian/alerts/schedule
   Access: guardian_admin only
   Returns: { schedule: GuardianAlertSchedule | null, defaults?: {...} }

2. POST /api/guardian/alerts/schedule
   Access: guardian_admin only
   Body: { intervalMinutes: number, debounceMinutes: number }
   Returns: { schedule: GuardianAlertSchedule } (201 Created)

3. POST /api/guardian/alerts/scheduled-run
   Access: Secret header (x-guardian-scheduler-secret)
   Returns: { success: true, evaluated: number, totalEventsFired: number, results: [...] }

SCHEDULING CONFIGURATION:
-------------------------
Interval Minutes:
- Purpose: How often to evaluate alert rules
- Range: 1-1440 minutes (1 minute to 24 hours)
- Default: 5 minutes
- Recommended:
  - 1-5 minutes: High-frequency monitoring (API errors)
  - 10-30 minutes: Medium-frequency monitoring (warehouse metrics)
  - 60-1440 minutes: Low-frequency monitoring (daily reports)

Debounce Minutes:
- Purpose: Prevent repeated alerts within time window
- Range: 1-1440 minutes
- Default: 10 minutes
- How it works: Skip evaluation if now - last_run_at < interval_minutes
- Recommended:
  - Equal to interval: No extra debounce
  - 2x interval: Conservative debounce
  - Higher than interval: Reduced noise

Configuration Examples:
```json
// High-frequency monitoring (API health)
{"intervalMinutes": 1, "debounceMinutes": 1}

// Standard monitoring (general alerts)
{"intervalMinutes": 5, "debounceMinutes": 10}

// Low-frequency monitoring (daily reports)
{"intervalMinutes": 1440, "debounceMinutes": 1440}
```

CRON JOB SETUP:
---------------
Vercel Cron (vercel.json):
```json
{
  "crons": [
    {
      "path": "/api/guardian/alerts/scheduled-run",
      "schedule": "*/5 * * * *"
    }
  ]
}
```

Environment Variable:
```bash
GUARDIAN_SCHEDULER_SECRET=your-secret-key-here
```

GitHub Actions (.github/workflows/guardian-scheduler.yml):
```yaml
name: Guardian Alert Scheduler
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
jobs:
  evaluate:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Guardian Evaluation
        run: |
          curl -X POST \
            -H "x-guardian-scheduler-secret: ${{ secrets.GUARDIAN_SCHEDULER_SECRET }}" \
            https://your-app.vercel.app/api/guardian/alerts/scheduled-run
```

USAGE EXAMPLES:
---------------
1. Configure schedule (admin):
```bash
curl -X POST \
  -H "Cookie: sb-access-token=<TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"intervalMinutes": 5, "debounceMinutes": 10}' \
  http://localhost:3008/api/guardian/alerts/schedule
```

2. Fetch schedule (admin):
```bash
curl -H "Cookie: sb-access-token=<TOKEN>" \
  http://localhost:3008/api/guardian/alerts/schedule
```

3. Trigger scheduled evaluation (cron):
```bash
curl -X POST \
  -H "x-guardian-scheduler-secret: <SECRET>" \
  http://localhost:3008/api/guardian/alerts/scheduled-run
```

Response:
```json
{
  "success": true,
  "evaluated": 5,
  "totalEventsFired": 12,
  "results": [
    {
      "tenantId": "uuid-1",
      "rulesEvaluated": 10,
      "eventsFired": 3
    }
  ]
}
```

4. Manual evaluation still works (G36):
```bash
curl -X POST \
  -H "Cookie: sb-access-token=<TOKEN>" \
  http://localhost:3008/api/guardian/alerts/evaluate
```

USE CASES:
----------
1. Continuous API Monitoring
   - Config: {"intervalMinutes": 1, "debounceMinutes": 1}
   - Rule: {"field": "status_code", "op": "equals", "value": 500}
   - Trigger: Every minute

2. Daily Performance Reports
   - Config: {"intervalMinutes": 1440, "debounceMinutes": 1440}
   - Rule: {"metric": "requests_per_hour", "op": "less_than", "value": 100}
   - Trigger: Once per day

3. Business Hours Monitoring
   - Config: {"intervalMinutes": 10, "debounceMinutes": 10}
   - Cron: */10 9-17 * * 1-5 (every 10 min, 9am-5pm, Mon-Fri)

4. Cost-Optimized Monitoring
   - Config: {"intervalMinutes": 60, "debounceMinutes": 60}
   - Reduces evaluation frequency to minimize costs

PHASE G37 SCOPE:
----------------
‚úÖ guardian_alert_schedules table (per-tenant configuration)
‚úÖ Admin API for schedule configuration (GET/POST)
‚úÖ Scheduled evaluation endpoint (cron-triggered)
‚úÖ Debounce logic (interval-based rate limiting)
‚úÖ Reuses G36 evaluation pipeline
‚úÖ Idempotent and concurrent-safe
‚úÖ Comprehensive error handling
‚úÖ Batch evaluation across tenants
‚úÖ Evaluation summary reporting
‚úÖ Secret header authentication
‚úÖ Service role RLS bypass for cron

FUTURE PHASES (G38+):
---------------------
‚ùå External notification delivery (email, webhook, pager) - G38
‚ùå Alert deduplication (prevent duplicate events) - G38
‚ùå Alert suppression (maintenance mode) - G38
‚ùå Alert cooldown per rule (rule-level rate limiting) - G39
‚ùå Complex condition logic (AND/OR/NOT) - G39
‚ùå Time-window aggregations (OVER 5 minutes) - G40
‚ùå Alert analytics (frequency, MTTA/MTTR) - G41

INTEGRATION POINTS:
-------------------
‚úÖ G30 (Tenant Hardening) - Uses getGuardianTenantContext()
‚úÖ G31 (Tenant Enforcement) - Returns 401 if unauthenticated
‚úÖ G32 (Access Levels) - Enforces admin-only access
‚úÖ G35 (Alert Rules & Events) - Reads guardian_alert_rules, writes guardian_alert_events
‚úÖ G36 (Evaluation Engine) - Reuses evaluateGuardianAlertRules()

Enables:
üîú G38 (External Notifications) - Send alerts via email, webhook, pager
üîú G39 (Complex Logic) - AND/OR/NOT operators
üîú G40 (Time Windows) - Aggregate metrics over time
üîú G41 (Alert Analytics) - Track frequency, MTTA/MTTR

PERFORMANCE:
------------
Evaluation Complexity (per tenant):
- Fetch schedules: O(1)
- Fetch rules: O(n) where n = active rules (~5-20)
- Evaluate rules: O(n √ó m) where m = data points (~220)
- Insert events: O(k) where k = fired events (~1-5)
- Update schedule: O(1)

Batch Evaluation:
- Fetch all due schedules: O(t) where t = total tenants
- Evaluate all due tenants: O(t √ó n √ó m)
- Total runtime: ~50-200ms per tenant √ó due tenants

Example: 100 tenants, 5 due, 10 rules each = ~1-5 seconds total

Optimization Opportunities:
- Parallelize tenant evaluation (Promise.all)
- Cache warehouse/telemetry data across tenants
- Batch insert alert events
- Add circuit breaker for failing tenants

SECURITY:
---------
Cron Endpoint:
- Protected by secret header (x-guardian-scheduler-secret)
- Secret must be strong random string (32+ chars)
- Secret stored in environment variable only
- No tenant data exposed in response
- Logged attempts tracked for audit

Schedule Configuration:
- Admin-only API (guardian_admin)
- Validation prevents invalid intervals
- RLS enforces tenant isolation
- Service role bypass for cron endpoint only

Evaluation:
- Reuses G36 evaluation engine (validated in G36)
- Tenant-scoped queries via RLS
- No cross-tenant data leakage
- Error handling prevents information disclosure

TESTING CHECKLIST:
------------------
[ ] Apply migration 543 (guardian_alert_schedules table)
[ ] Set GUARDIAN_SCHEDULER_SECRET env var
[ ] Configure schedule via POST /api/guardian/alerts/schedule
[ ] Verify schedule fetched via GET /api/guardian/alerts/schedule
[ ] Create test alert rule with simple condition
[ ] Trigger scheduled-run endpoint with secret header
[ ] Verify events created in guardian_alert_events
[ ] Verify last_run_at updated in guardian_alert_schedules
[ ] Test debounce (schedule-run called twice within interval)
[ ] Test invalid secret header (should return 403)
[ ] Test guardian_viewer access (should return 403)
[ ] Test evaluation summary response
[ ] Configure Vercel Cron or Supabase Scheduler
[ ] Monitor cron logs for successful runs

MANUAL TESTING SCRIPT:
----------------------
```bash
# 1. Set environment variable
export GUARDIAN_SCHEDULER_SECRET="test-secret-$(openssl rand -hex 16)"

# 2. Configure schedule (admin only)
curl -X POST \
  -H "Cookie: sb-access-token=<ADMIN_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{"intervalMinutes": 1, "debounceMinutes": 1}' \
  http://localhost:3008/api/guardian/alerts/schedule

# 3. Verify schedule created
curl -H "Cookie: sb-access-token=<ADMIN_TOKEN>" \
  http://localhost:3008/api/guardian/alerts/schedule

# 4. Create test alert rule (from G35)
curl -X POST \
  -H "Cookie: sb-access-token=<ADMIN_TOKEN>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test scheduled rule",
    "severity": "low",
    "source": "telemetry",
    "channel": "in_app",
    "condition": {"field": "id", "op": "exists"}
  }' \
  http://localhost:3008/api/guardian/alerts

# 5. Trigger scheduled evaluation
curl -X POST \
  -H "x-guardian-scheduler-secret: $GUARDIAN_SCHEDULER_SECRET" \
  http://localhost:3008/api/guardian/alerts/scheduled-run

# 6. Verify events created
curl -H "Cookie: sb-access-token=<ADMIN_TOKEN>" \
  http://localhost:3008/api/guardian/alerts

# 7. Test debounce (should skip evaluation)
sleep 30
curl -X POST \
  -H "x-guardian-scheduler-secret: $GUARDIAN_SCHEDULER_SECRET" \
  http://localhost:3008/api/guardian/alerts/scheduled-run
```

GUARDIAN SYSTEM STATUS:
-----------------------
Total Phases: G01-G37 ‚úÖ
Total Tables: 39 (+1 new: guardian_alert_schedules)
Total Migrations: 542 (alert rules) + 543 (scheduling) + 584 (access audit)
Total API Routes: 11 (+3 new)
Scheduling Engine: Active ‚úÖ
Production Ready: YES (after testing)

API ROUTES:
-----------
1. GET /api/guardian/telemetry - All roles ‚úÖ
2. GET /api/guardian/warehouse - Analyst+ ‚úÖ
3. GET /api/guardian/replay - Analyst+ ‚úÖ
4. GET /api/guardian/scenarios - Admin only ‚úÖ
5. GET /api/guardian/access-audit - Analyst+ ‚úÖ
6. GET /api/guardian/alerts - All roles ‚úÖ
7. POST /api/guardian/alerts - Admin only ‚úÖ
8. POST /api/guardian/alerts/evaluate - Admin only ‚úÖ
9. GET /api/guardian/alerts/schedule - Admin only ‚úÖ (NEW)
10. POST /api/guardian/alerts/schedule - Admin only ‚úÖ (NEW)
11. POST /api/guardian/alerts/scheduled-run - Secret header ‚úÖ (NEW)

UI PAGES:
---------
1. /guardian/telemetry - All roles ‚úÖ
2. /guardian/warehouse - Analyst+ ‚úÖ
3. /guardian/replay - Analyst+ ‚úÖ
4. /guardian/scenarios - Admin only ‚úÖ
5. /guardian/access-audit - Analyst+ ‚úÖ
6. /guardian/alerts - All roles ‚úÖ

BEFORE (G36):
-------------
- Manual evaluation only (POST /api/guardian/alerts/evaluate)
- No scheduled evaluation
- No per-tenant configuration
- No debounce logic
- Admin must manually trigger evaluation
- No batch evaluation across tenants

AFTER (G37):
------------
- ‚úÖ Automated scheduled evaluation (cron-triggered)
- ‚úÖ Per-tenant scheduling configuration (interval + debounce)
- ‚úÖ Admin API for schedule management
- ‚úÖ Debounce logic prevents spam
- ‚úÖ Batch evaluation across all due tenants
- ‚úÖ Reuses G36 evaluation pipeline
- ‚úÖ Secure cron endpoint (secret header auth)
- ‚úÖ Evaluation summary reporting
- ‚úÖ Manual evaluation still works (G36 endpoint unchanged)

BREAKING CHANGES:
-----------------
‚úÖ None - Pure addition of scheduling system

No changes to:
- G36 manual evaluation endpoint
- Guardian UI or rule creation
- Alert rule schema or evaluation logic
- Existing database tables
- Access control policies

NEXT STEPS:
-----------
1. Apply migration 543:
   - Supabase Dashboard ‚Üí SQL Editor
   - Paste supabase/migrations/543_guardian_alert_schedule.sql
   - Run migration

2. Set environment variable:
   ```bash
   GUARDIAN_SCHEDULER_SECRET=your-secret-key-here
   ```

3. Configure Vercel Cron or Supabase Scheduler:
   - Add cron job to call /api/guardian/alerts/scheduled-run
   - Schedule: */5 * * * * (every 5 minutes)

4. Test schedule configuration:
   - POST /api/guardian/alerts/schedule with intervalMinutes=1
   - Verify schedule created

5. Test scheduled evaluation:
   - Trigger scheduled-run endpoint with secret header
   - Verify events created

NEXT PHASE: G38 - External Alert Notifications
-----------------------------------------------
Planned Features:
- Email notification delivery (SendGrid, Resend)
- Webhook notification delivery (custom endpoints)
- Pager notification delivery (PagerDuty, Opsgenie)
- Notification templates (subject, body, payload)
- Delivery retry logic (exponential backoff)
- Delivery status tracking (sent, failed, retried)
- Channel configuration per rule
- Notification preferences per user
- Delivery analytics (success rate, latency)

---
Generated: 2025-12-10
Phase: Guardian G37 - Automated Alert Scheduling Engine
Type: Scheduled Evaluation System
