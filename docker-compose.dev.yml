version: '3.8'

# Unite-Hub Development Setup with MCP Integration
# Usage: docker-compose -f docker-compose.dev.yml up -d
# All 28 MCP tools available to Unite-Hub container

services:
  ############################################################################
  # UNITE-HUB (Main Development Environment)
  ############################################################################

  unite-hub:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: unite-hub-dev
    volumes:
      # Source code (live editing)
      - ./src:/app/src:cached
      - ./public:/app/public:cached
      - ./supabase:/app/supabase:cached
      - ./pages:/app/pages:cached
      - ./components:/app/components:cached
      - ./lib:/app/lib:cached

      # Config files (read-only)
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./next.config.js:/app/next.config.js:ro
      - ./.env.local:/app/.env.local:ro

      # Performance optimization
      - node_modules:/app/node_modules
      - nextjs_cache:/app/.next

    ports:
      - "3008:3008"

    environment:
      - NODE_ENV=development
      - NEXT_TELEMETRY_DISABLED=1
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MCP_GATEWAY_URL=http://mcp-gateway:3200

    command: npm run dev
    depends_on:
      mcp-gateway:
        condition: service_healthy
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3008/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  ############################################################################
  # MCP GATEWAY
  ############################################################################

  mcp-gateway:
    image: node:22-alpine
    container_name: mcp-gateway
    working_dir: /app
    volumes:
      - ./docker/mcp/servers:/app
    environment:
      - MCP_SERVERS=filesystem:filesystem-mcp:3100,process:process-mcp:3101,database:database-mcp:3102,git:git-mcp:3103
      - MCP_GATEWAY_PORT=3200
      - MCP_LOG_LEVEL=info
      - RATE_LIMIT_REQUESTS=2000
      - RATE_LIMIT_WINDOW_MS=60000
    entrypoint: sh -c "npm install 2>/dev/null && node gateway-server.mjs"
    ports:
      - "3200:3200"
    networks:
      - mcp-network
    depends_on:
      - filesystem-mcp
      - process-mcp
      - database-mcp
      - git-mcp
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3200/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  ############################################################################
  # MCP SERVERS
  ############################################################################

  filesystem-mcp:
    image: node:22-alpine
    container_name: filesystem-mcp
    working_dir: /app
    volumes:
      - ./docker/mcp/servers:/app
      - .:/workspace:ro
    environment:
      - WORKSPACE_ROOT=/workspace
      - MAX_FILE_SIZE_MB=100
      - MCP_LOG_LEVEL=info
    entrypoint: sh -c "apk add --no-cache ripgrep fd && npm install 2>/dev/null && node filesystem-server.mjs"
    ports:
      - "3100:3100"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  process-mcp:
    image: node:22-alpine
    container_name: process-mcp
    working_dir: /app
    volumes:
      - ./docker/mcp/servers:/app
      - .:/workspace:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WORKSPACE_ROOT=/workspace
      - MAX_CONCURRENT_PROCESSES=10
      - COMMAND_TIMEOUT_MS=300000
      - MCP_LOG_LEVEL=info
    entrypoint: sh -c "apk add --no-cache docker git && npm install 2>/dev/null && node process-server.mjs"
    ports:
      - "3101:3101"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3101/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  database-mcp:
    image: node:22-alpine
    container_name: database-mcp
    working_dir: /app
    volumes:
      - ./docker/mcp/servers:/app
      - .:/workspace:ro
    environment:
      - WORKSPACE_ROOT=/workspace
      - SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - QUERY_TIMEOUT_MS=30000
      - MAX_RESULT_ROWS=1000
      - MCP_LOG_LEVEL=info
    entrypoint: sh -c "npm install 2>/dev/null && node database-server.mjs"
    ports:
      - "3102:3102"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3102/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  git-mcp:
    image: node:22-alpine
    container_name: git-mcp
    working_dir: /app
    volumes:
      - ./docker/mcp/servers:/app
      - .:/workspace:ro
    environment:
      - WORKSPACE_ROOT=/workspace
      - MCP_LOG_LEVEL=info
    entrypoint: sh -c "apk add --no-cache git openssh-client && npm install 2>/dev/null && node git-server.mjs"
    ports:
      - "3103:3103"
    networks:
      - mcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3103/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  node_modules:
  nextjs_cache:

networks:
  mcp-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
