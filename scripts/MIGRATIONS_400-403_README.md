# Migrations 400-403 Consolidation & Execution Guide

## Overview

This guide explains how to use the migration consolidation script and run migrations 400-403 in Supabase.

## What Are Migrations 400-403?

These are Phase 4 migrations for the Unite-Hub rebuild:

### Migration 400: Core Foundation Consolidation
- **Purpose**: RLS helpers and audit log enhancements
- **Duration**: 30-45 seconds
- **Tables Modified**: `audit_logs`, `workspaces`
- **Functions Created**: `is_staff()`, `is_founder()`, `is_client()`, `get_user_role()`, `has_role()`, `check_connection_pool_status()`
- **New Columns**: `severity`, `category`, `success`, `duration_ms`, `error_message`, `ip_address`, `user_agent`, `org_id`

### Migration 401: Synthex Tier Management
- **Purpose**: Subscription tier management for client portal
- **Duration**: 30-45 seconds
- **Tables Created**: `synthex_tier_limits`, `synthex_usage_tracking`
- **Tables Modified**: `workspaces`
- **Functions Created**: `workspace_has_tier()`, `workspace_has_feature()`, `get_workspace_limit()`, `workspace_within_limit()`
- **Tiers**: Starter ($29/mo), Professional ($99/mo), Elite ($299/mo)
- **New Columns**: `current_tier`, `subscription_status`, `trial_ends_at`, `stripe_customer_id`, `stripe_subscription_id`

### Migration 402: Extended RLS Policies
- **Purpose**: Complete RLS coverage for Founder OS tables
- **Duration**: 45-60 seconds (most policies)
- **Tables Protected**: 14 Founder OS tables + workspace tables
- **Scoping Patterns**:
  - `owner_user_id` for founder-owned tables
  - `founder_business_id` for business-specific data
  - `workspace_id` for workspace-scoped data
- **Policies Created**: 30+ RLS policies

### Migration 403: Rate Limiting Infrastructure
- **Purpose**: Database support for API rate limiting
- **Duration**: 30-45 seconds
- **Tables Created**: `rate_limit_logs`, `rate_limit_overrides`, `blocked_ips`
- **Functions Created**: `is_ip_blocked()`, `get_rate_limit_override()`, `log_rate_limit()`, `cleanup_rate_limit_logs()`
- **Views Created**: `rate_limit_analytics`

**Total Duration**: ~2-3 minutes

## Step 1: Generate Consolidated Migration

Run the script to consolidate migrations 400-403:

```bash
node scripts/run-migrations.mjs
```

This will:
1. Read all 4 migration files
2. Combine them with section markers
3. Add 8 verification queries at the end
4. Output to `supabase/migrations/CONSOLIDATED_400-403.sql` (52.8 KB)
5. Print detailed instructions

## Step 2: Run in Supabase Dashboard

### Prerequisites
- Supabase account with Unite-Hub project
- Access to SQL Editor (requires project owner or admin role)
- ~2-3 minutes of execution time

### Instructions

1. **Open Supabase Dashboard**
   - Go to https://supabase.com/dashboard
   - Click your Unite-Hub project

2. **Go to SQL Editor**
   - Click "SQL Editor" in the left sidebar
   - Click "+ New Query" button
   - Name it: "Migrations 400-403"

3. **Copy the Consolidated SQL**
   - Open: `supabase/migrations/CONSOLIDATED_400-403.sql`
   - Select all (Ctrl+A on Windows/Linux, Cmd+A on Mac)
   - Copy (Ctrl+C or Cmd+C)
   - Paste into Supabase SQL Editor (Ctrl+V or Cmd+V)

4. **Execute**
   - Click "Run" button (or press Ctrl+Enter / Cmd+Enter)
   - Watch the progress bar
   - Wait for "Execution succeeded" message

5. **Verify Success**
   - Scroll to bottom of results
   - Review the 8 verification queries:
     1. ✓ Total tables >= 33
     2. ✓ Total functions >= 20
     3. ✓ RLS enabled on 11+ tables
     4. ✓ synthex_tier_limits has 3 rows
     5. ✓ rate_limit tables have indexes
     6. ✓ audit_logs has 7 new columns
     7. ✓ workspaces has 6 new columns
     8. ✓ RLS policies (40+ policies)

## File Structure

```
supabase/migrations/
├── 400_core_foundation_consolidation.sql     (248 lines)
├── 401_synthex_tier_management.sql           (339 lines)
├── 402_extended_rls_policies.sql             (415 lines)
├── 403_rate_limiting_infrastructure.sql      (254 lines)
└── CONSOLIDATED_400-403.sql                  (1,449 lines) ← Generated by script
```

## Safety Features

All migrations are **idempotent** and **safe to re-run**:

- Uses `CREATE TABLE IF NOT EXISTS` for new tables
- Uses `ALTER TABLE...IF NOT EXISTS` for new columns
- Uses `DROP POLICY IF EXISTS` before creating policies
- Uses `CREATE OR REPLACE FUNCTION` for functions
- No data loss (only adds/modifies structure)
- No breaking changes (backward compatible)

## Troubleshooting

### Error: "function is_workspace_member(...) does not exist"

**Expected** - This means migrations 023-024 weren't run yet.

**Solution**: Check `.claude/SCHEMA_REFERENCE.md` to verify `is_workspace_member` exists. If it doesn't:
1. Run migrations 023-024 first
2. Then run 400-403

### Error: "table ... does not exist"

**Expected** - Some tables may not exist yet.

**Solution**: The migration gracefully skips missing tables (see NOTICE messages). This is intentional.

### Error: "permission denied" on RLS policies

**Cause**: Connected as wrong role

**Solution**: Use Supabase Dashboard SQL Editor (auto-uses service role). Don't use psql or other tools unless connected as superuser.

### Timeout after 5 minutes

**Cause**: Query too complex, Supabase timeout

**Solution**: Split into smaller batches:
1. Run migration 400 separately
2. Run migration 401 separately
3. Run migration 402 separately
4. Run migration 403 separately

Then run verification queries.

### "Execution succeeded" but verification queries fail

**Cause**: Some migrations had issues (check for errors above the query results)

**Solution**:
1. Look for red error messages before the verification queries
2. Check the specific migration section that failed
3. Review the error message and the migration code
4. For RLS policy errors, see `.claude/RLS_WORKFLOW.md`

## After Migrations Complete

### Verify Installation

```bash
npm run integrity:check
```

Expected output: 100% PASS (all 15+ tables, 9 services, 23 API routes, 8 agents present)

### Check Deployment

- Visit your app: Should work normally
- Database queries: Should be scoped to workspaces
- Founder OS features: Should work (if tables created)
- Rate limiting: Logs will appear in `rate_limit_logs` table

### Monitor Performance

Check these functions to verify:

```sql
-- Check pool status
SELECT * FROM public.check_connection_pool_status();

-- Check tier limits
SELECT * FROM synthex_tier_limits;

-- Check rate limit analytics
SELECT * FROM rate_limit_analytics LIMIT 10;
```

## Documentation References

- **RLS Workflow**: `.claude/RLS_WORKFLOW.md`
- **Schema Reference**: `.claude/SCHEMA_REFERENCE.md`
- **RLS Migration Postmortem**: `docs/RLS_MIGRATION_POSTMORTEM.md`
- **Integrity Check**: `scripts/INTEGRITY_CHECK_README.md`
- **Production Patterns**: `docs/ANTHROPIC_PRODUCTION_PATTERNS.md`

## Key Statistics

| Metric | Value |
|--------|-------|
| Total LOC | 1,449 lines |
| Migrations | 4 (400-403) |
| New Tables | 5 (`synthex_tier_limits`, `synthex_usage_tracking`, `rate_limit_logs`, `rate_limit_overrides`, `blocked_ips`) |
| New Columns | 13 (7 in `audit_logs`, 6 in `workspaces`) |
| New Functions | 14 (6 core, 4 tier, 4 rate-limit) |
| New Policies | 30+ RLS policies |
| Total Duration | 2-3 minutes |
| File Size | 52.8 KB |

## Success Checklist

After running migrations, verify:

- [ ] Execution succeeded message appears
- [ ] No red error messages in output
- [ ] 8 verification queries all return results
- [ ] Tables >= 33 total
- [ ] Functions >= 20 total
- [ ] RLS enabled on 11+ tables
- [ ] synthex_tier_limits has 3 rows
- [ ] rate_limit tables have indexes
- [ ] audit_logs has 7 new columns
- [ ] workspaces has 6 new columns
- [ ] 40+ RLS policies exist
- [ ] `npm run integrity:check` passes 100%

## Questions?

See the troubleshooting section above or check:
- `.claude/RLS_WORKFLOW.md` for RLS-specific issues
- `docs/RLS_MIGRATION_POSTMORTEM.md` for common errors
- `scripts/INTEGRITY_CHECK_README.md` for system verification

---

**Last Updated**: 2025-11-29
**Script Version**: 1.0.0
**Status**: Production Ready
