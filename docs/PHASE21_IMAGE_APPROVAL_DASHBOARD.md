# Phase 21 - UNITE-HUB Image Approval Dashboard & Admin Workflow

**Date**: 2025-11-21
**Status**: Implementation Ready
**Branch**: `feature/phase21-image-approval-dashboard`

## Executive Summary

Phase 21 creates an admin console for human approval of all AI-generated images. The dashboard provides role-based access to review, approve, reject, or request revisions for images generated by the Gemini Nano Banana 2 engine.

## UI Routes

### Admin Routes

| Route | Description | Access |
|-------|-------------|--------|
| `/admin/images` | Image list with filters | Admin, Manager, Designer |
| `/admin/images/pending` | Pending review queue | Admin, Manager, Designer |
| `/admin/images/[id]` | Image review page | Admin, Manager, Designer |
| `/admin/images/stats` | Approval statistics | Admin only |
| `/admin/images/history` | Approval history log | Admin, Manager |

## Access Control

### Role-Based Permissions

| Role | View | Approve | Reject | Revise | Stats |
|------|------|---------|--------|--------|-------|
| Admin | Yes | Yes | Yes | Yes | Yes |
| Manager | Yes | Yes | Yes | Yes | No |
| Designer | Yes | Yes | Yes | Yes | No |
| Staff | No | No | No | No | No |
| Client | No | No | No | No | No |

### Middleware Implementation

```typescript
// src/middleware/image-admin.ts

import { NextRequest, NextResponse } from 'next/server';
import { getSupabaseServer } from '@/lib/supabase';

const ALLOWED_ROLES = ['admin', 'manager', 'designer'];

export async function imageAdminMiddleware(req: NextRequest) {
  const authHeader = req.headers.get('authorization');
  const token = authHeader?.replace('Bearer ', '');

  if (!token) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { supabaseBrowser } = await import('@/lib/supabase');
  const { data: authData, error } = await supabaseBrowser.auth.getUser(token);

  if (error || !authData.user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const supabase = await getSupabaseServer();

  // Get user role from user_organizations
  const { data: membership } = await supabase
    .from('user_organizations')
    .select('role')
    .eq('user_id', authData.user.id)
    .single();

  if (!membership || !ALLOWED_ROLES.includes(membership.role)) {
    return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 });
  }

  return null; // Allow request
}
```

## Screen Specifications

### S1: Image List Screen (`/admin/images`)

#### Layout

```
+--------------------------------------------------+
| Image Management                    [Filter] [+]  |
+--------------------------------------------------+
| Status: [All v] Context: [All v] Date: [Range]   |
+--------------------------------------------------+
| [Pending] [Revised] [Approved] [Rejected]        |
+--------------------------------------------------+
|                                                   |
| +-------+ +-------+ +-------+ +-------+          |
| | Thumb | | Thumb | | Thumb | | Thumb |          |
| +-------+ +-------+ +-------+ +-------+          |
| Status    Status    Status    Status              |
| Context   Context   Context   Context             |
| Date      Date      Date      Date                |
|                                                   |
| [Load More]                                       |
+--------------------------------------------------+
```

#### Component

```typescript
// src/app/(admin)/admin/images/page.tsx

'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Badge } from '@/components/ui/badge';
import { useAuth } from '@/contexts/AuthContext';
import Link from 'next/link';

interface ImageApproval {
  id: string;
  image_path: string;
  status: 'pending' | 'revised' | 'approved' | 'rejected';
  context_type: string;
  context_id: string;
  created_at: string;
  revision_count: number;
}

export default function ImageListPage() {
  const { session, currentOrganization } = useAuth();
  const [images, setImages] = useState<ImageApproval[]>([]);
  const [loading, setLoading] = useState(true);
  const [statusFilter, setStatusFilter] = useState<string>('all');
  const [contextFilter, setContextFilter] = useState<string>('all');

  useEffect(() => {
    fetchImages();
  }, [statusFilter, contextFilter]);

  const fetchImages = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({
        org_id: currentOrganization?.org_id || '',
        ...(statusFilter !== 'all' && { status: statusFilter }),
        ...(contextFilter !== 'all' && { context_type: contextFilter }),
      });

      const response = await fetch(`/api/admin/images?${params}`, {
        headers: {
          Authorization: `Bearer ${session?.access_token}`,
        },
      });

      const data = await response.json();
      setImages(data.images || []);
    } catch (error) {
      console.error('Failed to fetch images:', error);
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'pending': return 'bg-yellow-500';
      case 'revised': return 'bg-blue-500';
      case 'approved': return 'bg-green-500';
      case 'rejected': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  };

  return (
    <div className="container mx-auto py-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Image Management</h1>
        <Link href="/admin/images/pending">
          <Button>Review Pending</Button>
        </Link>
      </div>

      {/* Filters */}
      <div className="flex gap-4 mb-6">
        <Select value={statusFilter} onValueChange={setStatusFilter}>
          <SelectTrigger className="w-[180px]">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="pending">Pending</SelectItem>
            <SelectItem value="revised">Revised</SelectItem>
            <SelectItem value="approved">Approved</SelectItem>
            <SelectItem value="rejected">Rejected</SelectItem>
          </SelectContent>
        </Select>

        <Select value={contextFilter} onValueChange={setContextFilter}>
          <SelectTrigger className="w-[180px]">
            <SelectValue placeholder="Context" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Contexts</SelectItem>
            <SelectItem value="onboarding">Onboarding</SelectItem>
            <SelectItem value="dashboard">Dashboard</SelectItem>
            <SelectItem value="email">Email</SelectItem>
            <SelectItem value="report">Report</SelectItem>
            <SelectItem value="social">Social Media</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Status tabs */}
      <div className="flex gap-2 mb-6">
        {['all', 'pending', 'revised', 'approved', 'rejected'].map((status) => (
          <Button
            key={status}
            variant={statusFilter === status ? 'default' : 'outline'}
            size="sm"
            onClick={() => setStatusFilter(status)}
          >
            {status.charAt(0).toUpperCase() + status.slice(1)}
          </Button>
        ))}
      </div>

      {/* Image grid */}
      {loading ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {[...Array(8)].map((_, i) => (
            <Card key={i} className="animate-pulse">
              <div className="h-48 bg-gray-200 rounded-t-lg" />
              <CardContent className="p-4">
                <div className="h-4 bg-gray-200 rounded w-3/4 mb-2" />
                <div className="h-4 bg-gray-200 rounded w-1/2" />
              </CardContent>
            </Card>
          ))}
        </div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {images.map((image) => (
            <Link key={image.id} href={`/admin/images/${image.id}`}>
              <Card className="cursor-pointer hover:shadow-lg transition-shadow">
                <div className="relative h-48">
                  <img
                    src={image.image_path}
                    alt="Generated image"
                    className="w-full h-full object-cover rounded-t-lg"
                  />
                  <Badge
                    className={`absolute top-2 right-2 ${getStatusColor(image.status)}`}
                  >
                    {image.status}
                  </Badge>
                </div>
                <CardContent className="p-4">
                  <p className="font-medium">{image.context_type}</p>
                  <p className="text-sm text-gray-500">
                    {new Date(image.created_at).toLocaleDateString()}
                  </p>
                  {image.revision_count > 0 && (
                    <p className="text-xs text-blue-500">
                      {image.revision_count} revision(s)
                    </p>
                  )}
                </CardContent>
              </Card>
            </Link>
          ))}
        </div>
      )}

      {images.length === 0 && !loading && (
        <div className="text-center py-12">
          <p className="text-gray-500">No images found</p>
        </div>
      )}
    </div>
  );
}
```

### S2: Pending Review Queue (`/admin/images/pending`)

#### Layout

```
+--------------------------------------------------+
| Pending Review Queue              [12 items]      |
+--------------------------------------------------+
| Priority: High to Low                             |
+--------------------------------------------------+
|                                                   |
| +-------------------------------------------+    |
| | [Image]  | Onboarding Welcome Banner      |    |
| |          | Created: Nov 21, 2025 9:00 AM  |    |
| |          | Org: Disaster Recovery AU      |    |
| |          | [Review]                       |    |
| +-------------------------------------------+    |
|                                                   |
| +-------------------------------------------+    |
| | [Image]  | Dashboard Analytics Tile       |    |
| |          | Created: Nov 21, 2025 9:15 AM  |    |
| |          | Org: CARSI                     |    |
| |          | [Review]                       |    |
| +-------------------------------------------+    |
|                                                   |
+--------------------------------------------------+
```

#### Component

```typescript
// src/app/(admin)/admin/images/pending/page.tsx

'use client';

import { useState, useEffect } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { useAuth } from '@/contexts/AuthContext';
import Link from 'next/link';

interface PendingImage {
  id: string;
  image_path: string;
  prompt: string;
  context_type: string;
  context_id: string;
  created_at: string;
  org_name: string;
}

export default function PendingQueuePage() {
  const { session, currentOrganization } = useAuth();
  const [pendingImages, setPendingImages] = useState<PendingImage[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchPendingImages();
  }, []);

  const fetchPendingImages = async () => {
    setLoading(true);
    try {
      const response = await fetch(
        `/api/internal/image-engine/pending?org_id=${currentOrganization?.org_id}&status=pending`,
        {
          headers: {
            Authorization: `Bearer ${session?.access_token}`,
          },
        }
      );

      const data = await response.json();
      setPendingImages(data.images || []);
    } catch (error) {
      console.error('Failed to fetch pending images:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="container mx-auto py-6">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold">Pending Review Queue</h1>
          <p className="text-gray-500">
            {pendingImages.length} image{pendingImages.length !== 1 ? 's' : ''} awaiting review
          </p>
        </div>
        <Link href="/admin/images">
          <Button variant="outline">View All Images</Button>
        </Link>
      </div>

      {loading ? (
        <div className="space-y-4">
          {[...Array(5)].map((_, i) => (
            <Card key={i} className="animate-pulse">
              <CardContent className="p-4">
                <div className="flex gap-4">
                  <div className="w-24 h-24 bg-gray-200 rounded" />
                  <div className="flex-1">
                    <div className="h-5 bg-gray-200 rounded w-1/2 mb-2" />
                    <div className="h-4 bg-gray-200 rounded w-1/3 mb-2" />
                    <div className="h-4 bg-gray-200 rounded w-1/4" />
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      ) : (
        <div className="space-y-4">
          {pendingImages.map((image) => (
            <Card key={image.id} className="hover:shadow-md transition-shadow">
              <CardContent className="p-4">
                <div className="flex gap-4">
                  <div className="w-24 h-24 flex-shrink-0">
                    <img
                      src={image.image_path}
                      alt="Pending image"
                      className="w-full h-full object-cover rounded"
                    />
                  </div>
                  <div className="flex-1">
                    <div className="flex justify-between items-start">
                      <div>
                        <h3 className="font-medium">
                          {image.context_type} - {image.context_id}
                        </h3>
                        <p className="text-sm text-gray-500">
                          Created: {new Date(image.created_at).toLocaleString()}
                        </p>
                        <p className="text-sm text-gray-500">
                          Org: {image.org_name}
                        </p>
                      </div>
                      <Badge className="bg-yellow-500">Pending</Badge>
                    </div>
                    <p className="text-sm mt-2 line-clamp-2">{image.prompt}</p>
                    <div className="mt-3">
                      <Link href={`/admin/images/${image.id}`}>
                        <Button size="sm">Review</Button>
                      </Link>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {pendingImages.length === 0 && !loading && (
        <div className="text-center py-12">
          <p className="text-gray-500 text-lg">No pending images</p>
          <p className="text-gray-400">All images have been reviewed</p>
        </div>
      )}
    </div>
  );
}
```

### S3: Image Review Page (`/admin/images/[id]`)

#### Layout

```
+--------------------------------------------------+
| Image Review                [Back to Queue]       |
+--------------------------------------------------+
|                                                   |
| +------------------------+  +------------------+ |
| |                        |  | Details          | |
| |    [Large Image]       |  | Status: Pending  | |
| |                        |  | Context: Onboard | |
| |                        |  | Created: Nov 21  | |
| +------------------------+  | Revisions: 0     | |
|                             |                  | |
| Prompt:                     | Cost: $0.0015    | |
| "Professional welcome..."   +------------------+ |
|                                                   |
| Optimized Prompt:           +------------------+ |
| "Professional welcome..."   | Actions          | |
|                             | [Approve]        | |
| Metadata:                   | [Request Revise] | |
| - Keywords: welcome, prof   | [Reject]         | |
| - Location: Brisbane        +------------------+ |
|                                                   |
| +------------------+                              |
| | Revision Notes   |                              |
| | [Text area]      |                              |
| +------------------+                              |
|                                                   |
| History:                                          |
| - Nov 21 9:00: Created (pending)                  |
+--------------------------------------------------+
```

#### Component

```typescript
// src/app/(admin)/admin/images/[id]/page.tsx

'use client';

import { useState, useEffect } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Textarea } from '@/components/ui/textarea';
import { useAuth } from '@/contexts/AuthContext';
import { ArrowLeft, Check, X, RotateCcw } from 'lucide-react';
import Link from 'next/link';

interface ImageDetails {
  id: string;
  image_path: string;
  metadata_path: string;
  prompt: string;
  optimized_prompt: string;
  status: string;
  context_type: string;
  context_id: string;
  revision_count: number;
  revision_notes: string;
  generation_cost: number;
  created_at: string;
  reviewed_by: string;
  reviewed_at: string;
  approved_by: string;
  approved_at: string;
  rejected_by: string;
  rejected_at: string;
  rejection_reason: string;
  metadata: {
    seo: { keywords: string[] };
    geo: { location: string };
  };
}

interface HistoryEntry {
  id: string;
  previous_status: string;
  new_status: string;
  changed_by: string;
  notes: string;
  created_at: string;
}

export default function ImageReviewPage() {
  const params = useParams();
  const router = useRouter();
  const { session } = useAuth();
  const [image, setImage] = useState<ImageDetails | null>(null);
  const [history, setHistory] = useState<HistoryEntry[]>([]);
  const [loading, setLoading] = useState(true);
  const [notes, setNotes] = useState('');
  const [processing, setProcessing] = useState(false);

  useEffect(() => {
    fetchImageDetails();
    fetchHistory();
  }, [params.id]);

  const fetchImageDetails = async () => {
    try {
      const response = await fetch(`/api/admin/images/${params.id}`, {
        headers: {
          Authorization: `Bearer ${session?.access_token}`,
        },
      });
      const data = await response.json();
      setImage(data.image);
    } catch (error) {
      console.error('Failed to fetch image:', error);
    } finally {
      setLoading(false);
    }
  };

  const fetchHistory = async () => {
    try {
      const response = await fetch(`/api/internal/image-engine/history?image_id=${params.id}`, {
        headers: {
          Authorization: `Bearer ${session?.access_token}`,
        },
      });
      const data = await response.json();
      setHistory(data.history || []);
    } catch (error) {
      console.error('Failed to fetch history:', error);
    }
  };

  const handleAction = async (action: 'approve' | 'reject' | 'request_revision') => {
    setProcessing(true);
    try {
      const response = await fetch('/api/internal/image-engine/approve', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${session?.access_token}`,
        },
        body: JSON.stringify({
          imageId: params.id,
          action,
          notes,
          ...(action === 'request_revision' && { revisionPrompt: notes }),
        }),
      });

      if (response.ok) {
        // Refresh data
        await fetchImageDetails();
        await fetchHistory();
        setNotes('');

        // If approved or rejected, go back to queue
        if (action === 'approve' || action === 'reject') {
          router.push('/admin/images/pending');
        }
      } else {
        const error = await response.json();
        alert(`Error: ${error.error}`);
      }
    } catch (error) {
      console.error('Action failed:', error);
      alert('Action failed');
    } finally {
      setProcessing(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'pending': return 'bg-yellow-500';
      case 'revised': return 'bg-blue-500';
      case 'approved': return 'bg-green-500';
      case 'rejected': return 'bg-red-500';
      default: return 'bg-gray-500';
    }
  };

  const canTakeAction = image?.status === 'pending' || image?.status === 'revised';

  if (loading) {
    return (
      <div className="container mx-auto py-6">
        <div className="animate-pulse">
          <div className="h-8 bg-gray-200 rounded w-1/4 mb-6" />
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="lg:col-span-2 h-96 bg-gray-200 rounded" />
            <div className="h-96 bg-gray-200 rounded" />
          </div>
        </div>
      </div>
    );
  }

  if (!image) {
    return (
      <div className="container mx-auto py-6">
        <p>Image not found</p>
      </div>
    );
  }

  return (
    <div className="container mx-auto py-6">
      {/* Header */}
      <div className="flex justify-between items-center mb-6">
        <div className="flex items-center gap-4">
          <Link href="/admin/images/pending">
            <Button variant="ghost" size="sm">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Queue
            </Button>
          </Link>
          <h1 className="text-2xl font-bold">Image Review</h1>
        </div>
        <Badge className={getStatusColor(image.status)}>
          {image.status}
        </Badge>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Image and prompts */}
        <div className="lg:col-span-2 space-y-6">
          {/* Image */}
          <Card>
            <CardContent className="p-0">
              <img
                src={image.image_path}
                alt="Image for review"
                className="w-full rounded-lg"
              />
            </CardContent>
          </Card>

          {/* Prompts */}
          <Card>
            <CardHeader>
              <CardTitle>Prompt</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm">{image.prompt}</p>
            </CardContent>
          </Card>

          {image.optimized_prompt && (
            <Card>
              <CardHeader>
                <CardTitle>Optimized Prompt</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm whitespace-pre-wrap">{image.optimized_prompt}</p>
              </CardContent>
            </Card>
          )}

          {/* Metadata */}
          {image.metadata && (
            <Card>
              <CardHeader>
                <CardTitle>Metadata</CardTitle>
              </CardHeader>
              <CardContent className="space-y-2">
                {image.metadata.seo?.keywords && (
                  <div>
                    <span className="font-medium">Keywords: </span>
                    {image.metadata.seo.keywords.join(', ')}
                  </div>
                )}
                {image.metadata.geo?.location && (
                  <div>
                    <span className="font-medium">Location: </span>
                    {image.metadata.geo.location}
                  </div>
                )}
              </CardContent>
            </Card>
          )}

          {/* History */}
          {history.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle>History</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-2">
                  {history.map((entry) => (
                    <div key={entry.id} className="text-sm border-b pb-2">
                      <div className="flex justify-between">
                        <span>
                          {entry.previous_status} â†’ {entry.new_status}
                        </span>
                        <span className="text-gray-500">
                          {new Date(entry.created_at).toLocaleString()}
                        </span>
                      </div>
                      {entry.notes && (
                        <p className="text-gray-600 mt-1">{entry.notes}</p>
                      )}
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Sidebar */}
        <div className="space-y-6">
          {/* Details */}
          <Card>
            <CardHeader>
              <CardTitle>Details</CardTitle>
            </CardHeader>
            <CardContent className="space-y-3">
              <div>
                <span className="font-medium">Status: </span>
                <Badge className={getStatusColor(image.status)}>
                  {image.status}
                </Badge>
              </div>
              <div>
                <span className="font-medium">Context: </span>
                {image.context_type}
              </div>
              <div>
                <span className="font-medium">Created: </span>
                {new Date(image.created_at).toLocaleString()}
              </div>
              <div>
                <span className="font-medium">Revisions: </span>
                {image.revision_count}
              </div>
              <div>
                <span className="font-medium">Cost: </span>
                ${image.generation_cost.toFixed(4)}
              </div>
            </CardContent>
          </Card>

          {/* Actions */}
          {canTakeAction && (
            <Card>
              <CardHeader>
                <CardTitle>Actions</CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <Textarea
                  placeholder="Add notes (required for revision/rejection)"
                  value={notes}
                  onChange={(e) => setNotes(e.target.value)}
                  rows={4}
                />

                <div className="space-y-2">
                  <Button
                    className="w-full bg-green-600 hover:bg-green-700"
                    onClick={() => handleAction('approve')}
                    disabled={processing}
                  >
                    <Check className="w-4 h-4 mr-2" />
                    Approve
                  </Button>

                  <Button
                    className="w-full bg-blue-600 hover:bg-blue-700"
                    onClick={() => handleAction('request_revision')}
                    disabled={processing || !notes}
                  >
                    <RotateCcw className="w-4 h-4 mr-2" />
                    Request Revision
                  </Button>

                  <Button
                    className="w-full bg-red-600 hover:bg-red-700"
                    onClick={() => handleAction('reject')}
                    disabled={processing || !notes}
                  >
                    <X className="w-4 h-4 mr-2" />
                    Reject
                  </Button>
                </div>

                {!notes && (
                  <p className="text-xs text-gray-500">
                    Notes required for revision or rejection
                  </p>
                )}
              </CardContent>
            </Card>
          )}

          {/* Revision notes if revised */}
          {image.revision_notes && (
            <Card>
              <CardHeader>
                <CardTitle>Revision Notes</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm">{image.revision_notes}</p>
              </CardContent>
            </Card>
          )}

          {/* Rejection reason if rejected */}
          {image.rejection_reason && (
            <Card>
              <CardHeader>
                <CardTitle>Rejection Reason</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-sm">{image.rejection_reason}</p>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}
```

## API Endpoints

### Admin Image Endpoints

#### GET /api/admin/images

```typescript
// src/app/api/admin/images/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { getSupabaseServer } from '@/lib/supabase';
import { imageAdminMiddleware } from '@/middleware/image-admin';

export async function GET(req: NextRequest) {
  const middlewareResult = await imageAdminMiddleware(req);
  if (middlewareResult) return middlewareResult;

  const { searchParams } = new URL(req.url);
  const orgId = searchParams.get('org_id');
  const status = searchParams.get('status');
  const contextType = searchParams.get('context_type');
  const limit = parseInt(searchParams.get('limit') || '50');
  const offset = parseInt(searchParams.get('offset') || '0');

  const supabase = await getSupabaseServer();

  let query = supabase
    .from('image_approvals')
    .select('*')
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1);

  if (orgId) query = query.eq('org_id', orgId);
  if (status && status !== 'all') query = query.eq('status', status);
  if (contextType && contextType !== 'all') query = query.eq('context_type', contextType);

  const { data, error } = await query;

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ images: data, total: data?.length || 0 });
}
```

#### GET /api/admin/images/[id]

```typescript
// src/app/api/admin/images/[id]/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { getSupabaseServer } from '@/lib/supabase';
import { imageAdminMiddleware } from '@/middleware/image-admin';

export async function GET(
  req: NextRequest,
  { params }: { params: { id: string } }
) {
  const middlewareResult = await imageAdminMiddleware(req);
  if (middlewareResult) return middlewareResult;

  const supabase = await getSupabaseServer();

  const { data, error } = await supabase
    .from('image_approvals')
    .select('*')
    .eq('id', params.id)
    .single();

  if (error || !data) {
    return NextResponse.json({ error: 'Image not found' }, { status: 404 });
  }

  // Load metadata from sidecar file if exists
  let metadata = null;
  if (data.metadata_path) {
    try {
      const fs = await import('fs/promises');
      const metadataContent = await fs.readFile(data.metadata_path, 'utf-8');
      metadata = JSON.parse(metadataContent);
    } catch {
      // Metadata file not found, continue without it
    }
  }

  return NextResponse.json({
    image: {
      ...data,
      metadata,
    },
  });
}
```

#### GET /api/admin/images/stats

```typescript
// src/app/api/admin/images/stats/route.ts

import { NextRequest, NextResponse } from 'next/server';
import { getSupabaseServer } from '@/lib/supabase';
import { imageAdminMiddleware } from '@/middleware/image-admin';

export async function GET(req: NextRequest) {
  const middlewareResult = await imageAdminMiddleware(req);
  if (middlewareResult) return middlewareResult;

  const { searchParams } = new URL(req.url);
  const orgId = searchParams.get('org_id');

  const supabase = await getSupabaseServer();

  // Get counts by status
  const statuses = ['pending', 'revised', 'approved', 'rejected'];
  const counts: Record<string, number> = {};

  for (const status of statuses) {
    let query = supabase
      .from('image_approvals')
      .select('id', { count: 'exact', head: true })
      .eq('status', status);

    if (orgId) query = query.eq('org_id', orgId);

    const { count } = await query;
    counts[status] = count || 0;
  }

  // Get total cost
  let costQuery = supabase
    .from('image_approvals')
    .select('generation_cost');

  if (orgId) costQuery = costQuery.eq('org_id', orgId);

  const { data: costData } = await costQuery;
  const totalCost = costData?.reduce((sum, r) => sum + (r.generation_cost || 0), 0) || 0;

  // Get average approval time
  const { data: approvedData } = await supabase
    .from('image_approvals')
    .select('created_at, approved_at')
    .eq('status', 'approved')
    .not('approved_at', 'is', null);

  let avgApprovalTime = 0;
  if (approvedData && approvedData.length > 0) {
    const totalTime = approvedData.reduce((sum, r) => {
      const created = new Date(r.created_at).getTime();
      const approved = new Date(r.approved_at).getTime();
      return sum + (approved - created);
    }, 0);
    avgApprovalTime = totalTime / approvedData.length / (1000 * 60 * 60); // hours
  }

  return NextResponse.json({
    counts,
    total: Object.values(counts).reduce((a, b) => a + b, 0),
    totalCost,
    avgApprovalTimeHours: avgApprovalTime.toFixed(1),
  });
}
```

## Implementation Tasks

### T1: Create Admin Routes

- [ ] Create `/admin/images/page.tsx` (Image List)
- [ ] Create `/admin/images/pending/page.tsx` (Pending Queue)
- [ ] Create `/admin/images/[id]/page.tsx` (Review Page)
- [ ] Create `/admin/images/stats/page.tsx` (Statistics)
- [ ] Add routes to navigation

### T2: Implement API Endpoints

- [ ] GET /api/admin/images
- [ ] GET /api/admin/images/[id]
- [ ] GET /api/admin/images/stats
- [ ] Add middleware for role verification

### T3: Build UI Components

- [ ] Image grid with filters
- [ ] Pending queue list
- [ ] Review page with actions
- [ ] Status badges
- [ ] History timeline

### T4: Add Role-Based Access

- [ ] Create imageAdminMiddleware
- [ ] Verify roles on all admin endpoints
- [ ] Hide UI elements for unauthorized users

### T5: Testing

- [ ] Test all approval workflows
- [ ] Test role-based access
- [ ] Test filters and pagination
- [ ] Test history tracking

## Privacy Enforcement

All UI labels must use sanitized terms:

```typescript
// In components
const getPublicLabel = (contextType: string): string => {
  const labels: Record<string, string> = {
    'onboarding': 'Custom onboarding illustration',
    'dashboard': 'Custom dashboard visual',
    'email': 'Custom email graphic',
    'report': 'Custom report diagram',
    'social': 'Custom social media asset',
  };
  return labels[contextType] || 'Custom illustration';
};

// Usage in UI
<p className="text-sm text-gray-500">
  {getPublicLabel(image.context_type)}
</p>
```

## Completion Definition

Phase 21 is complete when:

1. **All admin routes created**: `/admin/images/*`
2. **Role-based access enforced**: Only Admin/Manager/Designer can access
3. **Image list working**: Filters, pagination, status display
4. **Pending queue working**: Priority list, quick review access
5. **Review page working**: Approve/reject/revise actions
6. **Statistics available**: Counts, costs, approval times
7. **History tracked**: All status changes logged
8. **Privacy enforced**: No AI vendor terms in UI

## Next Phase Preview

### Phase 22: Production Hardening & Launch Prep

- Performance optimization
- Security audit
- Load testing
- Documentation finalization
- Launch checklist

---

*Phase 21 - Image Approval Dashboard & Admin Workflow*
*Unite-Hub Status: ADMIN DASHBOARD READY*
