# UNITE-HUB V1 MVP - Priority TODO List

**Generated by**: Orchestrator Agent
**Date**: 2025-11-15
**Status**: CRITICAL FIXES REQUIRED

---

## P0 - CRITICAL (System Breaking) üî¥

These issues MUST be fixed before the system can function properly.

### 1. Fix Database Layer Import Error

**File**: `src/lib/db.ts`
**Line**: 58
**Impact**: ALL workspace operations fail with `ReferenceError: supabaseServer is not defined`

**Action Required**:
```typescript
// Line 1 - Add to imports
import { createClient, getSupabaseServer } from "./supabase";

// Line 58 - Replace broken code
// BEFORE (BROKEN):
const { data: workspace, error } = await supabaseServer  // ‚ùå UNDEFINED

// AFTER (FIXED):
const supabaseServer = getSupabaseServer();
const { data: workspace, error } = await supabaseServer
  .from("workspaces")
  .select("*")
  .eq("id", workspaceId)
  .single();
```

**Test**:
- [ ] Run `npm run dev`
- [ ] Navigate to `/dashboard/overview`
- [ ] Verify no `ReferenceError` in console
- [ ] Confirm workspace data loads

**Estimated Time**: 5 minutes

---

### 2. Add Workspace Filtering to Dashboard Overview

**File**: `src/app/dashboard/overview/page.tsx`
**Lines**: 24-26 (contacts query), 30-32 (campaigns query)
**Impact**: Data isolation broken - shows ALL workspaces' data

**Action Required**:
```typescript
// BEFORE (BROKEN) - Line 24-26
const { data: contacts, error: contactsError } = await supabase
  .from("contacts")
  .select("ai_score, status");
  // ‚ùå Missing workspace filter!

// AFTER (FIXED)
// First add null check
if (!workspaceId) {
  return (
    <div className="container mx-auto py-8">
      <p className="text-muted-foreground">No workspace selected. Please create or select a workspace.</p>
    </div>
  );
}

// Then add workspace filter
const { data: contacts, error: contactsError } = await supabase
  .from("contacts")
  .select("ai_score, status")
  .eq("workspace_id", workspaceId);  // ‚úÖ Added workspace filter

if (contactsError) {
  console.error("Error fetching contacts:", contactsError);
}

// BEFORE (BROKEN) - Line 30-32
const { data: campaigns, error: campaignsError } = await supabase
  .from("campaigns")
  .select("id");
  // ‚ùå Missing workspace filter!

// AFTER (FIXED)
const { data: campaigns, error: campaignsError } = await supabase
  .from("campaigns")
  .select("id")
  .eq("workspace_id", workspaceId);  // ‚úÖ Added workspace filter

if (campaignsError) {
  console.error("Error fetching campaigns:", campaignsError);
}
```

**Test**:
- [ ] Create 2 different workspaces
- [ ] Add contacts to each workspace
- [ ] Switch between workspaces
- [ ] Verify only workspace-specific contacts shown

**Estimated Time**: 10 minutes

---

### 3. Fix currentOrganization Undefined Error

**File**: `src/contexts/AuthContext.tsx`
**Lines**: 110-112
**Impact**: workspaceId becomes "default-org" string instead of UUID, causing database errors

**Action Required**:
```typescript
// BEFORE (BROKEN) - Line 110-112
const savedOrgId = localStorage.getItem("currentOrganizationId");
const savedOrg = orgs.find((org) => org.org_id === savedOrgId);
setCurrentOrganization(savedOrg || orgs[0] || null);
// ‚ùå If orgs array is empty, savedOrg || orgs[0] = undefined (not null)

// AFTER (FIXED)
if (orgs.length === 0) {
  setCurrentOrganization(null);
  console.log("No organizations found for user");
  return;
}

const savedOrgId = localStorage.getItem("currentOrganizationId");
const savedOrg = orgs.find((org) => org.org_id === savedOrgId);
setCurrentOrganization(savedOrg || orgs[0]);  // ‚úÖ Now guaranteed to be an org or null
```

**Additional Fix**: Ensure initialize-user is called on first login

```typescript
// In AuthContext.tsx, line ~95-100
useEffect(() => {
  const { data: { subscription } } = supabase.auth.onAuthStateChange(
    async (event, session) => {
      if (event === "SIGNED_IN" && session) {
        // Call initialize-user API
        try {
          await fetch("/api/auth/initialize-user", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });
        } catch (error) {
          console.error("Failed to initialize user:", error);
        }

        // Then fetch user profile and organizations
        await fetchUserProfile();
        await fetchOrganizations();
      }
      // ... rest of auth logic
    }
  );

  return () => subscription.unsubscribe();
}, []);
```

**Test**:
- [ ] Sign out completely
- [ ] Delete localStorage data
- [ ] Sign in with new Google account
- [ ] Verify organization created
- [ ] Verify workspace created
- [ ] Verify dashboard loads without errors

**Estimated Time**: 15 minutes

---

## P1 - HIGH (Core Features Broken) üü°

These issues prevent core features from working but don't crash the system.

### 4. Re-enable Authentication on API Routes

**Files**: Multiple API routes with `// TODO: Re-enable authentication` comments

**Action Required**:

Find all API routes with disabled auth:
```bash
grep -r "TODO: Re-enable authentication" src/app/api/
```

For each route, remove TODO and re-enable auth:

```typescript
// BEFORE (DISABLED)
// TODO: Re-enable authentication in production
// const { auth } = await import("@/lib/auth");
// const session = await auth();

// AFTER (ENABLED)
import { createClient } from "@/lib/supabase";

export async function POST(request: NextRequest) {
  // Check authentication
  const supabase = createClient();
  const { data: { user }, error: authError } = await supabase.auth.getUser();

  if (authError || !user) {
    return NextResponse.json(
      { error: "Unauthorized" },
      { status: 401 }
    );
  }

  // Continue with authenticated request
  // ...
}
```

**Routes to Fix** (confirmed):
1. `src/app/api/agents/contact-intelligence/route.ts`
2. `src/app/api/agents/content-personalization/route.ts`
3. (Search for others)

**Test**:
- [ ] Sign out
- [ ] Try calling protected API directly
- [ ] Verify 401 Unauthorized response
- [ ] Sign in
- [ ] Verify API works when authenticated

**Estimated Time**: 30 minutes

---

### 5. Implement Hot Leads Panel Button Functionality

**File**: `src/components/HotLeadsPanel.tsx`
**Lines**: 219-224 (Send Email), 225-231 (View Details)
**Impact**: Buttons do nothing when clicked

**Action Required**:

```typescript
import { useRouter } from "next/navigation";
import { useToast } from "@/components/ui/use-toast";

function HotLeadsPanel({ workspaceId }: { workspaceId: string }) {
  const router = useRouter();
  const { toast } = useToast();

  async function handleSendEmail(contactId: string) {
    try {
      const res = await fetch("/api/emails/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contactId,
          workspaceId,
          templateType: "followup"
        }),
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.error || "Failed to send email");
      }

      toast({
        title: "Email sent",
        description: "Your followup email has been queued for sending.",
      });
    } catch (error) {
      toast({
        variant: "destructive",
        title: "Error",
        description: error.message,
      });
    }
  }

  function handleViewDetails(contactId: string) {
    router.push(`/dashboard/contacts/${contactId}`);
  }

  return (
    <div>
      {/* ... existing code ... */}
      <Button onClick={() => handleSendEmail(contact.id)}>
        Send Email
      </Button>
      <Button variant="outline" onClick={() => handleViewDetails(contact.id)}>
        View Details
      </Button>
    </div>
  );
}
```

**Test**:
- [ ] Click "Send Email" button
- [ ] Verify email API is called
- [ ] Verify toast notification shows
- [ ] Click "View Details" button
- [ ] Verify navigation to contact detail page

**Estimated Time**: 20 minutes

---

### 6. Verify and Fix RLS Policies

**Task**: Ensure Row Level Security policies exist for all critical tables

**Action Required**:

Connect to Supabase SQL Editor and verify RLS policies:

```sql
-- Check which tables have RLS enabled
SELECT schemaname, tablename, rowsecurity
FROM pg_tables
WHERE schemaname = 'public'
  AND rowsecurity = false;

-- Should return empty (all tables should have RLS enabled)
```

If any tables missing RLS, add policies:

```sql
-- Enable RLS
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;

-- SELECT policy
CREATE POLICY "Users can view workspace records"
ON table_name
FOR SELECT
USING (
  workspace_id IN (
    SELECT w.id
    FROM workspaces w
    JOIN user_organizations uo ON uo.organization_id = w.organization_id
    WHERE uo.user_id = auth.uid()
  )
);

-- INSERT policy
CREATE POLICY "Users can create workspace records"
ON table_name
FOR INSERT
WITH CHECK (
  workspace_id IN (
    SELECT w.id
    FROM workspaces w
    JOIN user_organizations uo ON uo.organization_id = w.organization_id
    WHERE uo.user_id = auth.uid()
  )
);

-- UPDATE policy
CREATE POLICY "Users can update workspace records"
ON table_name
FOR UPDATE
USING (
  workspace_id IN (
    SELECT w.id
    FROM workspaces w
    JOIN user_organizations uo ON uo.organization_id = w.organization_id
    WHERE uo.user_id = auth.uid()
  )
);
```

**Tables to Verify**:
- [x] `user_profiles`
- [x] `organizations`
- [x] `user_organizations`
- [ ] `workspaces`
- [ ] `contacts`
- [ ] `emails`
- [ ] `campaigns`
- [ ] `drip_campaigns`
- [ ] `campaign_steps`
- [ ] `campaign_enrollments`
- [ ] `campaign_execution_logs`
- [ ] `generatedContent`
- [ ] `email_opens`
- [ ] `email_clicks`
- [ ] `integrations`
- [ ] `auditLogs`
- [ ] `aiMemory`

**Test**:
- [ ] Create two users in different organizations
- [ ] Each user creates contacts
- [ ] Verify users cannot see each other's contacts
- [ ] Verify users can only update their own records

**Estimated Time**: 45 minutes

---

## P2 - MEDIUM (User Experience) üü¢

These issues affect user experience but don't prevent core functionality.

### 7. Add Loading States to Dashboard Components

**Files**: Various dashboard pages and components

**Action Required**:

```typescript
// Example: Dashboard overview page
"use client";

import { useEffect, useState } from "react";
import { Skeleton } from "@/components/ui/skeleton";

export default function DashboardOverview() {
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    async function fetchStats() {
      try {
        setIsLoading(true);
        const res = await fetch("/api/dashboard/stats");
        const data = await res.json();
        setStats(data);
      } catch (err) {
        setError(err.message);
      } finally {
        setIsLoading(false);
      }
    }
    fetchStats();
  }, []);

  if (isLoading) {
    return (
      <div className="container mx-auto py-8 space-y-6">
        <Skeleton className="h-12 w-64" />
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <Skeleton className="h-32" />
          <Skeleton className="h-32" />
          <Skeleton className="h-32" />
          <Skeleton className="h-32" />
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="container mx-auto py-8">
        <div className="bg-destructive/10 border border-destructive text-destructive px-4 py-3 rounded">
          <p className="font-semibold">Error loading dashboard</p>
          <p className="text-sm">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div>
      {/* Normal dashboard content */}
    </div>
  );
}
```

**Components to Update**:
- [ ] Dashboard overview page
- [ ] Contacts list page
- [ ] Campaigns list page
- [ ] Hot leads panel
- [ ] Contact detail page

**Estimated Time**: 1 hour

---

### 8. Add Error Boundaries

**File**: `src/app/error.tsx` (create if missing)

**Action Required**:

```typescript
"use client";

import { useEffect } from "react";
import { Button } from "@/components/ui/button";

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string };
  reset: () => void;
}) {
  useEffect(() => {
    console.error("Application error:", error);
  }, [error]);

  return (
    <div className="container mx-auto py-16 text-center">
      <h2 className="text-2xl font-bold mb-4">Something went wrong!</h2>
      <p className="text-muted-foreground mb-6">
        {error.message || "An unexpected error occurred"}
      </p>
      <Button onClick={reset}>Try again</Button>
    </div>
  );
}
```

**Test**:
- [ ] Trigger an error in dashboard
- [ ] Verify error boundary catches it
- [ ] Verify user sees friendly error message
- [ ] Click "Try again" and verify recovery

**Estimated Time**: 15 minutes

---

## P3 - LOW (Polish & Optimization) üîµ

Nice-to-have improvements for V1.

### 9. Add Database Query Indexes

**Action Required**:

```sql
-- Contacts table indexes
CREATE INDEX IF NOT EXISTS idx_contacts_workspace_id ON contacts(workspace_id);
CREATE INDEX IF NOT EXISTS idx_contacts_email ON contacts(email);
CREATE INDEX IF NOT EXISTS idx_contacts_ai_score ON contacts(ai_score DESC);
CREATE INDEX IF NOT EXISTS idx_contacts_status ON contacts(status);

-- Emails table indexes
CREATE INDEX IF NOT EXISTS idx_emails_contact_id ON emails(contact_id);
CREATE INDEX IF NOT EXISTS idx_emails_workspace_id ON emails(workspace_id);
CREATE INDEX IF NOT EXISTS idx_emails_thread_id ON emails(thread_id);

-- Campaign indexes
CREATE INDEX IF NOT EXISTS idx_campaign_enrollments_contact ON campaign_enrollments(contact_id);
CREATE INDEX IF NOT EXISTS idx_campaign_enrollments_campaign ON campaign_enrollments(campaign_id);
CREATE INDEX IF NOT EXISTS idx_campaign_execution_logs_scheduled ON campaign_execution_logs(scheduled_for) WHERE status = 'pending';

-- Performance indexes
CREATE INDEX IF NOT EXISTS idx_email_opens_contact ON email_opens(contact_id);
CREATE INDEX IF NOT EXISTS idx_email_clicks_contact ON email_clicks(contact_id);
CREATE INDEX IF NOT EXISTS idx_audit_logs_org ON auditLogs(organization_id, created_at DESC);
```

**Test**:
- [ ] Run EXPLAIN ANALYZE on slow queries
- [ ] Verify index usage
- [ ] Measure query performance improvement

**Estimated Time**: 30 minutes

---

### 10. Implement Request Pagination

**Files**: API routes returning large datasets

**Action Required**:

```typescript
// Example: Contacts list API
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const page = parseInt(searchParams.get("page") || "0");
  const pageSize = parseInt(searchParams.get("pageSize") || "20");
  const workspaceId = searchParams.get("workspaceId");

  if (!workspaceId) {
    return NextResponse.json({ error: "workspaceId required" }, { status: 400 });
  }

  const supabase = createClient();

  // Get total count
  const { count } = await supabase
    .from("contacts")
    .select("*", { count: "exact", head: true })
    .eq("workspace_id", workspaceId);

  // Get paginated data
  const { data, error } = await supabase
    .from("contacts")
    .select("*")
    .eq("workspace_id", workspaceId)
    .order("created_at", { ascending: false })
    .range(page * pageSize, (page + 1) * pageSize - 1);

  if (error) {
    return NextResponse.json({ error: "Database error" }, { status: 500 });
  }

  return NextResponse.json({
    contacts: data,
    pagination: {
      page,
      pageSize,
      totalCount: count,
      totalPages: Math.ceil(count / pageSize),
      hasNextPage: (page + 1) * pageSize < count,
      hasPrevPage: page > 0,
    },
  });
}
```

**Estimated Time**: 1 hour

---

## Testing Checklist

After completing P0-P2 fixes:

### Manual Testing
- [ ] Sign up with new Google account
- [ ] Verify organization and workspace created
- [ ] Navigate to dashboard overview
- [ ] Verify stats load without errors
- [ ] Create a new contact
- [ ] Verify contact saved with workspace filter
- [ ] Switch to different workspace
- [ ] Verify contacts are workspace-specific
- [ ] Click hot leads "Send Email" button
- [ ] Verify email functionality works
- [ ] Sign out and verify protected routes redirect

### API Testing
- [ ] Test all 104 API endpoints (create test script)
- [ ] Verify authentication on protected routes
- [ ] Verify workspace filtering on all queries
- [ ] Test error responses (400, 401, 500)
- [ ] Test rate limiting (if implemented)

### Database Testing
- [ ] Verify RLS policies on all tables
- [ ] Test with 2 different users/workspaces
- [ ] Verify data isolation
- [ ] Test cascade deletes work correctly
- [ ] Check database indexes created

### Performance Testing
- [ ] Dashboard loads in < 2 seconds
- [ ] API responses < 500ms average
- [ ] No N+1 query problems
- [ ] Pagination works on large datasets

---

## Estimated Total Time

- **P0 (Critical)**: ~30 minutes
- **P1 (High)**: ~2.5 hours
- **P2 (Medium)**: ~1.5 hours
- **P3 (Low)**: ~1.5 hours
- **Testing**: ~2 hours

**Total**: ~8 hours (1 full development day)

---

## Success Criteria

Unite-Hub V1 MVP is ready when:

‚úÖ **P0 Fixes Complete**:
- [ ] Database layer works (no import errors)
- [ ] Workspace filtering on all dashboard pages
- [ ] Organization initialization reliable

‚úÖ **P1 Fixes Complete**:
- [ ] Authentication enabled on all API routes
- [ ] Hot leads buttons functional
- [ ] RLS policies verified on all tables

‚úÖ **Testing Complete**:
- [ ] All manual tests pass
- [ ] All API endpoints tested
- [ ] Database isolation verified

‚úÖ **Documentation Updated**:
- [ ] README.md updated
- [ ] .claude/claude.md updated
- [ ] CHANGELOG.md entry added

---

## Post-V1 Roadmap (NOT for MVP)

**Version 1.1** (Q1 2026):
- Advanced A/B testing framework
- Enhanced analytics dashboard
- Performance optimizations (caching, CDN)
- Comprehensive test suite (unit + integration + E2E)

**Version 2.0** (Q2 2026):
- Real-time collaboration features
- Mobile app (React Native)
- Advanced automation workflows
- Custom domain support
- White-label options

---

**Generated by Orchestrator Agent using Claude Developer Docs patterns**
**Last Updated**: 2025-11-15
