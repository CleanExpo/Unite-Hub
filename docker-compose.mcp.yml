# ==================================================
# Docker Compose - MCP Server Architecture
# Unite-Hub Model Context Protocol Servers
# ==================================================
version: '3.9'

services:
  # ==================================================
  # TIER 1: CRITICAL MCP SERVERS
  # ==================================================

  # Filesystem MCP - File operations offloading
  mcp-filesystem:
    build:
      context: .
      dockerfile: docker/mcp/Dockerfile.filesystem
    container_name: unite-hub-mcp-filesystem
    restart: unless-stopped
    volumes:
      - type: bind
        source: .
        target: /workspace
        read_only: false
      - mcp-filesystem-cache:/cache
    environment:
      MCP_SERVER_NAME: filesystem
      MCP_LOG_LEVEL: ${MCP_LOG_LEVEL:-info}
      WORKSPACE_ROOT: /workspace
      CACHE_DIR: /cache
      MAX_FILE_SIZE_MB: 50
      ENABLE_WATCH: "true"
    networks:
      - unite-hub-mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      - "com.unite-hub.mcp=true"
      - "com.unite-hub.mcp.tier=critical"
      - "com.unite-hub.mcp.server=filesystem"

  # Process MCP - Command execution offloading
  mcp-process:
    build:
      context: .
      dockerfile: docker/mcp/Dockerfile.process
    container_name: unite-hub-mcp-process
    restart: unless-stopped
    volumes:
      - type: bind
        source: .
        target: /workspace
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - npm-cache:/root/.npm
      - node-modules-cache:/workspace/node_modules/.cache
    environment:
      MCP_SERVER_NAME: process
      MCP_LOG_LEVEL: ${MCP_LOG_LEVEL:-info}
      WORKSPACE_ROOT: /workspace
      NODE_ENV: ${NODE_ENV:-development}
      COMMAND_TIMEOUT_MS: 300000
      MAX_CONCURRENT_PROCESSES: 5
      ENABLE_DOCKER_CONTROL: "true"
    networks:
      - unite-hub-mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    labels:
      - "com.unite-hub.mcp=true"
      - "com.unite-hub.mcp.tier=critical"
      - "com.unite-hub.mcp.server=process"

  # ==================================================
  # TIER 2: HIGH VALUE MCP SERVERS
  # ==================================================

  # Database MCP - PostgreSQL/Supabase access
  mcp-database:
    build:
      context: .
      dockerfile: docker/mcp/Dockerfile.database
    container_name: unite-hub-mcp-database
    restart: unless-stopped
    environment:
      MCP_SERVER_NAME: database
      MCP_LOG_LEVEL: ${MCP_LOG_LEVEL:-info}
      DATABASE_URL: ${DATABASE_URL}
      SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      POOL_SIZE: 10
      QUERY_TIMEOUT_MS: 30000
      READ_ONLY_MODE: "true"
    volumes:
      - ./supabase/migrations:/migrations:ro
    networks:
      - unite-hub-mcp-network
    depends_on:
      - mcp-filesystem
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3102/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 256M
    labels:
      - "com.unite-hub.mcp=true"
      - "com.unite-hub.mcp.tier=high"
      - "com.unite-hub.mcp.server=database"

  # Git MCP - Version control operations
  mcp-git:
    build:
      context: .
      dockerfile: docker/mcp/Dockerfile.git
    container_name: unite-hub-mcp-git
    restart: unless-stopped
    volumes:
      - type: bind
        source: .
        target: /workspace
      - git-cache:/root/.cache/git
    environment:
      MCP_SERVER_NAME: git
      MCP_LOG_LEVEL: ${MCP_LOG_LEVEL:-info}
      WORKSPACE_ROOT: /workspace
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GIT_AUTHOR_NAME: ${GIT_AUTHOR_NAME:-Claude Code}
      GIT_AUTHOR_EMAIL: ${GIT_AUTHOR_EMAIL:-claude@anthropic.com}
    networks:
      - unite-hub-mcp-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3103/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M
    labels:
      - "com.unite-hub.mcp=true"
      - "com.unite-hub.mcp.tier=high"
      - "com.unite-hub.mcp.server=git"

  # ==================================================
  # MCP GATEWAY - Unified access point
  # ==================================================

  mcp-gateway:
    build:
      context: .
      dockerfile: docker/mcp/Dockerfile.gateway
    container_name: unite-hub-mcp-gateway
    restart: unless-stopped
    ports:
      - "3200:3200"
    environment:
      MCP_GATEWAY_PORT: 3200
      MCP_LOG_LEVEL: ${MCP_LOG_LEVEL:-info}
      # Server registry
      MCP_SERVERS: "filesystem:mcp-filesystem:3100,process:mcp-process:3101,database:mcp-database:3102,git:mcp-git:3103"
      # Rate limiting
      RATE_LIMIT_REQUESTS: 1000
      RATE_LIMIT_WINDOW_MS: 60000
    networks:
      - unite-hub-mcp-network
    depends_on:
      - mcp-filesystem
      - mcp-process
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "com.unite-hub.mcp=true"
      - "com.unite-hub.mcp.server=gateway"

# ==================================================
# Networks
# ==================================================
networks:
  unite-hub-mcp-network:
    driver: bridge
    name: unite-hub-mcp-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ==================================================
# Volumes
# ==================================================
volumes:
  mcp-filesystem-cache:
    name: unite-hub-mcp-filesystem-cache
  npm-cache:
    name: unite-hub-npm-cache
  node-modules-cache:
    name: unite-hub-node-modules-cache
  git-cache:
    name: unite-hub-git-cache
